<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Spring整合MongoDB | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring整合MongoDB</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring整合MongoDB</h1><div class="post-meta">Aug 10, 2015<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="1、Maven导入依赖"><a href="#1、Maven导入依赖" class="headerlink" title="1、Maven导入依赖"></a>1、Maven导入依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;</span><br><span class="line">  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">  &lt;groupId&gt;ren.benben&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;diary&lt;/artifactId&gt;</span><br><span class="line">  &lt;packaging&gt;war&lt;/packaging&gt;</span><br><span class="line">  &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">  &lt;name&gt;diary Maven Webapp&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;http://maven.apache.org&lt;/url&gt;</span><br><span class="line">  &lt;properties&gt;</span><br><span class="line">        &lt;endorsed.dir&gt;$&#123;project.build.directory&#125;/endorsed&lt;/endorsed.dir&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;!-- 设置变量:用于统一管理Library的版本 --&gt;</span><br><span class="line">        &lt;javax.version&gt;7.0&lt;/javax.version&gt;</span><br><span class="line">        &lt;javax.servlet.version&gt;3.1.0&lt;/javax.servlet.version&gt;</span><br><span class="line">        &lt;javax.servlet.jstl.version&gt;1.2&lt;/javax.servlet.jstl.version&gt;</span><br><span class="line">        &lt;log4j.version&gt;1.2.16&lt;/log4j.version&gt;</span><br><span class="line">        &lt;org.slf4j.version&gt;1.7.1&lt;/org.slf4j.version&gt;</span><br><span class="line">        &lt;junit.version&gt;4.12&lt;/junit.version&gt;</span><br><span class="line">        &lt;org.htmlparser.version&gt;2.1&lt;/org.htmlparser.version&gt;</span><br><span class="line">        &lt;org.springframework.version&gt;4.1.1.RELEASE&lt;/org.springframework.version&gt;</span><br><span class="line">        &lt;spring-data-mongodb.version&gt;1.7.1.RELEASE&lt;/spring-data-mongodb.version&gt;</span><br><span class="line">        &lt;org.mongodb.version&gt;3.0.3&lt;/org.mongodb.version&gt;</span><br><span class="line">        &lt;javax.validation.version&gt;1.1.0.Final&lt;/javax.validation.version&gt;</span><br><span class="line">        &lt;org.hibernate.version&gt;5.0.2.Final&lt;/org.hibernate.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;javaee-web-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;javax.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;junit.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;javax.servlet.jstl.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;javax.servlet.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-jdk14&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.slf4j.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;log4j.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.htmlparser&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;htmlparser&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.htmlparser.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- spring framework --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-expression&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;org.springframework.version&#125;&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;spring-data-mongodb.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- javax.validation相关  --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;javax.validation&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;validation-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;javax.validation.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;  </span><br><span class="line">            &lt;groupId&gt;org.hibernate&lt;/groupId&gt;  </span><br><span class="line">            &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;  </span><br><span class="line">            &lt;version&gt;$&#123;org.hibernate.version&#125;&lt;/version&gt;  </span><br><span class="line">        &lt;/dependency&gt;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">    &lt;finalName&gt;diary&lt;/finalName&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>我们这里使用的Spring基础框架是4.1.x版本，使用1.7.x版本的Spring Data MongoDB对MongoDB进行CRUD操作。在使用Spring Data MongoDB框架时，需要使用到JSR-303 Validation验证标准。于是我们在这里引入 javax.validation的Jar和Hibernate Validator。值得注意的是，这里使用到的Hibernate Validator，不是我们要引入Hibernate框架，而仅仅是引入JSR-303的实现。</p>
<h2 id="2、Spring对MongoDB的配置"><a href="#2、Spring对MongoDB的配置" class="headerlink" title="2、Spring对MongoDB的配置"></a>2、Spring对MongoDB的配置</h2><h2 id="2-1-我的配置"><a href="#2-1-我的配置" class="headerlink" title="2.1 我的配置"></a>2.1 我的配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</span><br><span class="line">    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">    xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;</span><br><span class="line">    xmlns:task=&quot;http://www.springframework.org/schema/task&quot;  </span><br><span class="line">    xmlns:mongo=&quot;http://www.springframework.org/schema/data/mongo&quot;  </span><br><span class="line">    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans </span><br><span class="line">        http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</span><br><span class="line">        http://www.springframework.org/schema/context</span><br><span class="line">        http://www.springframework.org/schema/context/spring-context-4.1.xsd</span><br><span class="line">        http://www.springframework.org/schema/aop </span><br><span class="line">        http://www.springframework.org/schema/aop/spring-aop-4.1.xsd</span><br><span class="line">        http://www.springframework.org/schema/data/mongo       </span><br><span class="line">        http://www.springframework.org/schema/data/mongo/spring-mongo-1.7.xsd</span><br><span class="line">        http://www.springframework.org/schema/task </span><br><span class="line">        http://www.springframework.org/schema/task/spring-task-4.1.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:component-scan base-package=&quot;ren.benben.diary&quot; /&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;mongo:mongo host=&quot;127.0.0.1&quot; port=&quot;27017&quot; /&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;!-- mongo的工厂，通过它来取得mongo实例,dbname为mongodb的数据库名，没有的话会自动创建 --&gt;  </span><br><span class="line">    &lt;mongo:db-factory dbname=&quot;diary&quot; mongo-ref=&quot;mongo&quot; /&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;!-- mongodb的主要操作对象，所有对mongodb的增删改查的操作都是通过它完成 --&gt;  </span><br><span class="line">    &lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot;&gt;  </span><br><span class="line">        &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot; /&gt;  </span><br><span class="line">    &lt;/bean&gt;  </span><br><span class="line"></span><br><span class="line">    &lt;context:annotation-config /&gt;  </span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
<p>上面是我使用的配置。</p>
<h2 id="2-2-mongo-mongo"><a href="#2-2-mongo-mongo" class="headerlink" title="2.2 mongo:mongo"></a>2.2 mongo:mongo</h2><p>这里通过mongo:mongo标签来配置数据库的地址和端口,此标签默认的bean名称为mongo。如果你还需要配置MongoDB的其它参数，可以使用mongo:options标签。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;mongo:mongo host=&quot;localhost&quot; port=&quot;27017&quot;&gt;</span><br><span class="line">    &lt;mongo:options connections-per-host=&quot;8&quot;</span><br><span class="line">                   threads-allowed-to-block-for-connection-multiplier=&quot;4&quot;</span><br><span class="line">                   connect-timeout=&quot;1000&quot;</span><br><span class="line">                   max-wait-time=&quot;1500&#125;&quot;</span><br><span class="line">                   auto-connect-retry=&quot;true&quot;</span><br><span class="line">                   socket-keep-alive=&quot;true&quot;</span><br><span class="line">                   socket-timeout=&quot;1500&quot;</span><br><span class="line">                   slave-ok=&quot;true&quot;</span><br><span class="line">                   write-number=&quot;1&quot;</span><br><span class="line">                   write-timeout=&quot;0&quot;</span><br><span class="line">                   write-fsync=&quot;true&quot;/&gt;</span><br><span class="line"> &lt;/mongo:mongo/&gt;</span><br></pre></td></tr></table></figure></p>
<p>当然，在设置MongoDB参数时，也可以使用Java属性文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;context:property-placeholder location=&quot;classpath:/com/myapp/mongodb/config/mongo.properties&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;mongo:mongo host=&quot;$&#123;mongo.host&#125;&quot; port=&quot;$&#123;mongo.port&#125;&quot;&gt;</span><br><span class="line">  &lt;mongo:options</span><br><span class="line">     connections-per-host=&quot;$&#123;mongo.connectionsPerHost&#125;&quot;</span><br><span class="line">     threads-allowed-to-block-for-connection-multiplier=&quot;$&#123;mongo.threadsAllowedToBlockForConnectionMultiplier&#125;&quot;</span><br><span class="line">     connect-timeout=&quot;$&#123;mongo.connectTimeout&#125;&quot;</span><br><span class="line">     max-wait-time=&quot;$&#123;mongo.maxWaitTime&#125;&quot;</span><br><span class="line">     auto-connect-retry=&quot;$&#123;mongo.autoConnectRetry&#125;&quot;</span><br><span class="line">     socket-keep-alive=&quot;$&#123;mongo.socketKeepAlive&#125;&quot;</span><br><span class="line">     socket-timeout=&quot;$&#123;mongo.socketTimeout&#125;&quot;</span><br><span class="line">     slave-ok=&quot;$&#123;mongo.slaveOk&#125;&quot;</span><br><span class="line">     write-number=&quot;1&quot;</span><br><span class="line">     write-timeout=&quot;0&quot;</span><br><span class="line">     write-fsync=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/mongo:mongo&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-3-mongo-db-factory"><a href="#2-3-mongo-db-factory" class="headerlink" title="2.3 mongo:db-factory"></a>2.3 mongo:db-factory</h2><p>当你设置完MongoDB的基本参数后，你还得设置一个mongo数据工厂。此过程是由mongo:db-factory完成的，此标签的主要作用是通过它来取得mongo实例,dbname为diary的数据库名，没有的话会自动创建。这里mongo-ref引用的就是上文mongo:mongo这个bean。<br>mongo:db-factory标签默认的bean名称为mongoDbFactory。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;mongo:db-factory dbname=&quot;diary&quot; mongo-ref=&quot;mongo&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果你的DB需要用户名和密码才能访问的话，也可以通过mongo:db-factory来设置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;mongo:db-factory id=&quot;anotherMongoDbFactory&quot;</span><br><span class="line">                  host=&quot;localhost&quot;</span><br><span class="line">                  port=&quot;27017&quot;</span><br><span class="line">                  dbname=&quot;database&quot;</span><br><span class="line">                  username=&quot;benben&quot;</span><br><span class="line">                  password=&quot;123456&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-4-MongoTemplate"><a href="#2-4-MongoTemplate" class="headerlink" title="2.4 MongoTemplate"></a>2.4 MongoTemplate</h2><p>设置完mongo:db-factory后，我们就可以设置MongoTemplate了。MongoTemplate是Spring对MongoDB进行CRUD操作的主要工具类，其作用类似Spring整合Hibernate时的HibernateTemplate。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot;&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot; /&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>到这里为止，我们获取到MongoTemplate，配置就告一段落。</p>
<h2 id="3、实体类与映射"><a href="#3、实体类与映射" class="headerlink" title="3、实体类与映射"></a>3、实体类与映射</h2><p>新建一个文章Article实体类，对应数据库的article集合。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.article.model;</span><br><span class="line"></span><br><span class="line">import java.sql.Timestamp;</span><br><span class="line"></span><br><span class="line">import org.springframework.data.annotation.Id;</span><br><span class="line">import org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 文章</span><br><span class="line"> * @ClassName: Article </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年7月29日 下午2:19:58 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Document(collection = &quot;article&quot;)</span><br><span class="line">public class Article &#123;</span><br><span class="line">    @Id</span><br><span class="line">    private String id;</span><br><span class="line">    private String title;</span><br><span class="line">    private String descript;</span><br><span class="line">    private String link;</span><br><span class="line">    private String[] tags;</span><br><span class="line">    private Timestamp createTime;</span><br><span class="line">    private Timestamp updateTime;</span><br><span class="line">    private Integer state;</span><br><span class="line"></span><br><span class="line">    public String getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(String id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTitle() &#123;</span><br><span class="line">        return title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTitle(String title) &#123;</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getDescript() &#123;</span><br><span class="line">        return descript;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setDescript(String descript) &#123;</span><br><span class="line">        this.descript = descript;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getLink() &#123;</span><br><span class="line">        return link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setLink(String link) &#123;</span><br><span class="line">        this.link = link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String[] getTags() &#123;</span><br><span class="line">        return tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTags(String[] tags) &#123;</span><br><span class="line">        this.tags = tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Timestamp getCreateTime() &#123;</span><br><span class="line">        return createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCreateTime(Timestamp createTime) &#123;</span><br><span class="line">        this.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getState() &#123;</span><br><span class="line">        return state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setState(Integer state) &#123;</span><br><span class="line">        this.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Timestamp getUpdateTime() &#123;</span><br><span class="line">        return updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUpdateTime(Timestamp updateTime) &#123;</span><br><span class="line">        this.updateTime = updateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-1-Document"><a href="#3-1-Document" class="headerlink" title="3.1 @Document"></a>3.1 @Document</h2><p>使用@Document注解将实体类与数据库的集合相互映射。collection的值是数据库的集合名称。<br>加上@Document注解后，Spring的自动扫描功能就能识别出你的映射的实体类了。</p>
<h2 id="3-2-id属性"><a href="#3-2-id属性" class="headerlink" title="3.2 _id属性"></a>3.2 _id属性</h2><p>MongoDB需要我们为所有的文档都加上’_id’属性，其实就相当于SQL中的主键。所以我们在创建实体类时，也需要为实体类加一个id映射。</p>
<p>Spring Data MongoDB提供了多种方式，在实体类中映射_id</p>
<ul>
<li>直接在实体类中定义一个名为id的字符串属性</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private String id;</span><br></pre></td></tr></table></figure>
<ul>
<li>为实体类中的任意属性加上@Id注解</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Id private String id;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Id private String x;</span><br></pre></td></tr></table></figure>
<p>如果没特殊的需要，我们最好是使用@Id注解为标注名为id的属性作为_id，像我们demo中的实体类一样。这样程序的可读性高点。</p>
<h2 id="3-3-Field"><a href="#3-3-Field" class="headerlink" title="3.3 @Field"></a>3.3 @Field</h2><p>实体类的非_id属性，不加任何注解。可以同名的映射到数据库的集合中。如果你非得跟数据库中的不一样，Spring也提供了@Field为实现。<br>如，我们想把上文中的link属性，保存到集合的url属性中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Field(&quot;url&quot;)</span><br><span class="line">private String link;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、DAO基类及使用"><a href="#4、DAO基类及使用" class="headerlink" title="4、DAO基类及使用"></a>4、DAO基类及使用</h2><h2 id="4-1-IBaseDao接口及其实现"><a href="#4-1-IBaseDao接口及其实现" class="headerlink" title="4.1 IBaseDao接口及其实现"></a>4.1 IBaseDao接口及其实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.springframework.data.mongodb.core.query.Query;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Update;</span><br><span class="line">/**</span><br><span class="line"> * IBaseDao接口</span><br><span class="line"> * @ClassName: IBaseDao </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午3:15:40 </span><br><span class="line"> * </span><br><span class="line"> * @param &lt;T&gt;</span><br><span class="line"> */</span><br><span class="line">public interface IBaseDao&lt;T&gt; &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 获取查询数据的数量</span><br><span class="line">     * @Title: findCount </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param query</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return Long   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Long findCount(Query query);</span><br><span class="line">    /**</span><br><span class="line">     * 查询数据</span><br><span class="line">     * @Title: find </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param query</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return List&lt;T&gt;   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public List&lt;T&gt; find(Query query);</span><br><span class="line">    /**</span><br><span class="line">     * 分页查询数据</span><br><span class="line">     * @Title: findList </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param start</span><br><span class="line">     * @param @param limit</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return List&lt;T&gt;   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public List&lt;T&gt; findList(int start, int limit);</span><br><span class="line">    /**</span><br><span class="line">     * 根据id获取单个数据</span><br><span class="line">     * @Title: findOne </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param id</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return T   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public T findOne(String id);</span><br><span class="line">    /**</span><br><span class="line">     * 插入一条数据</span><br><span class="line">     * @Title: insert </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param entity   </span><br><span class="line">     * @return void   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void insert(T entity);</span><br><span class="line">    /**</span><br><span class="line">     * 更新数据</span><br><span class="line">     * @Title: update </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param entity</span><br><span class="line">     * @param @throws Exception   </span><br><span class="line">     * @return void   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void update(T entity) throws Exception;</span><br><span class="line">    /**</span><br><span class="line">     * 更新数据</span><br><span class="line">     * @Title: update </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param query</span><br><span class="line">     * @param @param update   </span><br><span class="line">     * @return void   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void update(Query query,Update update);</span><br><span class="line">    /**</span><br><span class="line">     * 删除数据</span><br><span class="line">     * @Title: remove </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param entity   </span><br><span class="line">     * @return void   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void remove(T entity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.ParameterizedType;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.domain.Sort;</span><br><span class="line">import org.springframework.data.domain.Sort.Direction;</span><br><span class="line">import org.springframework.data.domain.Sort.Order;</span><br><span class="line">import org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Query;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"></span><br><span class="line">import ren.benben.diary.api.util.MongoFactory;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * IBaseDao接口实现</span><br><span class="line"> * @ClassName: BaseDao </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨</span><br><span class="line"> * @date 2015年8月10日 下午3:57:18 </span><br><span class="line"> * </span><br><span class="line"> * @param &lt;T&gt;</span><br><span class="line"> */</span><br><span class="line">public class BaseDao&lt;T&gt; implements IBaseDao&lt;T&gt; &#123;</span><br><span class="line">    private Class&lt;T&gt; clazz;</span><br><span class="line"></span><br><span class="line">    public BaseDao() &#123;</span><br><span class="line">        ParameterizedType type = (ParameterizedType) getClass()</span><br><span class="line">                .getGenericSuperclass();</span><br><span class="line">        clazz = (Class&lt;T&gt;) type.getActualTypeArguments()[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private MongoTemplate mongoTemplate;</span><br><span class="line">    @Autowired</span><br><span class="line">    private MongoFactory mongoFactory;</span><br><span class="line"></span><br><span class="line">    public List&lt;T&gt; find(Query query)&#123;</span><br><span class="line">        return mongoTemplate.find(query, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;T&gt; findList(int skip, int limit) &#123;</span><br><span class="line">        Query query = new Query();</span><br><span class="line">        query.with(new Sort(new Order(Direction.ASC, &quot;_id&quot;)));</span><br><span class="line">        query.skip(skip).limit(limit);</span><br><span class="line">        return find(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public T findOne(String id) &#123;</span><br><span class="line">        Query query = new Query();</span><br><span class="line">        query.addCriteria(new Criteria(&quot;_id&quot;).is(id));</span><br><span class="line">        return mongoTemplate.findOne(query, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void insert(T entity) &#123;</span><br><span class="line">        mongoTemplate.insert(entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void update(T entity) throws Exception &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = mongoFactory.converObjectToParams(entity);</span><br><span class="line"></span><br><span class="line">        Query query = new Query();</span><br><span class="line">        query.addCriteria(new Criteria(&quot;_id&quot;).is(map.get(&quot;id&quot;)));</span><br><span class="line">        Update update = (Update) map.get(&quot;update&quot;);</span><br><span class="line"></span><br><span class="line">        this.update(query, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void update(Query query,Update update)&#123;</span><br><span class="line">        mongoTemplate.updateFirst(query, update, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long findCount(Query query)&#123;</span><br><span class="line">        return mongoTemplate.count(query, clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void remove(T entity)&#123;</span><br><span class="line">        mongoTemplate.remove(entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public MongoTemplate getMongoTemplate() &#123;</span><br><span class="line">        return mongoTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在DAO基类实现上，我们自己写了一个MongoFactory的工具类。此类主要是在做更新的时候使用。在update(T entity)方法中，做到类似HibernateTemplate一样，通过MongoFactory获取到entity的id及entity值不为空的属性，以id作为条件，更新这些属性。</p>
<p>相关的两个辅助工具类如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api.util;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Update;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Mongo辅助类</span><br><span class="line"> * @ClassName: MongoFactory </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午4:02:07 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class MongoFactory &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ObjectParams objectParams;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 把实体对象转为MongoDB更新需要的值</span><br><span class="line">     * @Title: converObjectToParams </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param obj</span><br><span class="line">     * @param @return</span><br><span class="line">     * @param @throws Exception   </span><br><span class="line">     * @return Map&lt;String,Object&gt;   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Map&lt;String, Object&gt; converObjectToParams(Object obj) throws Exception&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        Update update = new Update();</span><br><span class="line">        Map&lt;String, String&gt; params = objectParams.createParams(obj);</span><br><span class="line">        String id = params.get(&quot;id&quot;);</span><br><span class="line">        Set&lt;Map.Entry&lt;String, String&gt;&gt; set = params.entrySet();</span><br><span class="line">        for (Iterator&lt;Map.Entry&lt;String, String&gt;&gt; it = set.iterator(); it.hasNext();) &#123;</span><br><span class="line">            Map.Entry&lt;String, String&gt; entry = (Map.Entry&lt;String, String&gt;) it.next();</span><br><span class="line">            if(!entry.getKey().equals(&quot;id&quot;))&#123;</span><br><span class="line">                update.set(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map.put(&quot;id&quot;, id);</span><br><span class="line">        map.put(&quot;update&quot;, update);</span><br><span class="line"></span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api.util;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 实体参数映射工具</span><br><span class="line"> * @ClassName: ObjectParams </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午4:05:35 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class ObjectParams &#123;</span><br><span class="line">    private  String javaType = &quot;java&quot;;</span><br><span class="line">    /**</span><br><span class="line">     * 获取查询的参数</span><br><span class="line">     * </span><br><span class="line">     * @param object</span><br><span class="line">     * @return</span><br><span class="line">     * @throws Exception</span><br><span class="line">     */</span><br><span class="line">    public  Map&lt;String, String&gt; createParams(Object object) throws Exception &#123;</span><br><span class="line">        Map&lt;String, String&gt; params = new HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        setIntoParams(params,object, null);</span><br><span class="line">        return params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private  void setIntoParams(Map&lt;String, String&gt; params,Object object, String fatherName) throws IllegalAccessException,</span><br><span class="line">            Exception &#123;</span><br><span class="line">        Field[] fields = object.getClass().getDeclaredFields();</span><br><span class="line">        for (Field file : fields) &#123;</span><br><span class="line">            boolean accessFlag = file.isAccessible();</span><br><span class="line">            file.setAccessible(true);</span><br><span class="line">            String name = file.getName();</span><br><span class="line">            Object value = file.get(object);</span><br><span class="line"></span><br><span class="line">            if(file.getType().getName().equals(&quot;java.lang.Class&quot;))&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;else if(file.getType().getName().contains(javaType))&#123;</span><br><span class="line">                if(fatherName != null &amp;&amp; !fatherName.equals(&quot; &quot;))&#123;</span><br><span class="line">                    name = fatherName+&quot;.&quot;+name;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if(value != null)&#123;</span><br><span class="line">                    params.put(name, value+&quot;&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                if(value != null)&#123;</span><br><span class="line">                    setIntoParams(params,file.get(object), name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            file.setAccessible(accessFlag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-使用BaseDao"><a href="#4-2-使用BaseDao" class="headerlink" title="4.2 使用BaseDao"></a>4.2 使用BaseDao</h2><p>建立Article实体类的Dao。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.article.dao;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import ren.benben.diary.api.IBaseDao;</span><br><span class="line">import ren.benben.diary.api.util.Pagination;</span><br><span class="line">import ren.benben.diary.article.model.Article;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Article的Dao接口</span><br><span class="line"> * @ClassName: IArticleDao </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午4:09:25 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public interface IArticleDao extends IBaseDao&lt;Article&gt;&#123;</span><br><span class="line">    /**</span><br><span class="line">     * 根据link属性获取一条数据</span><br><span class="line">     * @Title: findOneByLink </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param link</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return Article   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Article findOneByLink(String link);</span><br><span class="line">    /**</span><br><span class="line">     * 根据link属性与title属性进行或运算获取一条数据</span><br><span class="line">     * @Title: findOneByLinkOrTitle </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param link</span><br><span class="line">     * @param @param title</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return Article   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Article findOneByLinkOrTitle(String link,String title);</span><br><span class="line">    /**</span><br><span class="line">     * 根据state属性获取createTime为最新的数据</span><br><span class="line">     * @Title: findNewestByState </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param state</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return Article   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Article findNewestByState(Integer state);</span><br><span class="line">    /**</span><br><span class="line">     * 根据state属性获取数据的数量</span><br><span class="line">     * @Title: findNewestByState </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param state</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return Article   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public Long findCount(Integer state);</span><br><span class="line">    /**</span><br><span class="line">     * 分页获取数据</span><br><span class="line">     * @Title: findListByPage </span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param page</span><br><span class="line">     * @param @param state</span><br><span class="line">     * @param @return   </span><br><span class="line">     * @return List&lt;Article&gt;   </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public List&lt;Article&gt; findListByPage(Pagination page,Integer state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.article.dao.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.springframework.data.domain.Sort;</span><br><span class="line">import org.springframework.data.domain.Sort.Direction;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Query;</span><br><span class="line">import org.springframework.data.mongodb.core.query.Update;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line">import ren.benben.diary.api.BaseDao;</span><br><span class="line">import ren.benben.diary.api.constant.Constant;</span><br><span class="line">import ren.benben.diary.api.util.Pagination;</span><br><span class="line">import ren.benben.diary.article.dao.IArticleDao;</span><br><span class="line">import ren.benben.diary.article.model.Article;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Article的Dao实现</span><br><span class="line"> * @ClassName: ArticleDao </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午4:14:21 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Repository  </span><br><span class="line">public class ArticleDao extends BaseDao&lt;Article&gt; implements IArticleDao &#123;</span><br><span class="line"></span><br><span class="line">    public Article findOneByLink(String link) &#123;</span><br><span class="line">        Query query = new Query(Criteria.where(&quot;link&quot;).is(link));</span><br><span class="line"></span><br><span class="line">        return getMongoTemplate().findOne(query, Article.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Article findNewestByState(Integer state)&#123;</span><br><span class="line">        Query query = createQuery(state);</span><br><span class="line">        query.limit(1).with(new Sort(new Sort.Order(Sort.Direction.DESC,&quot;createTime&quot;)));</span><br><span class="line"></span><br><span class="line">         List&lt;Article&gt; list = this.find(query);</span><br><span class="line"></span><br><span class="line">         if(list.size()&gt;0)&#123;</span><br><span class="line">             return list.get(0);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Article&gt; findListByPage(Pagination page,Integer state) &#123;  </span><br><span class="line">        Query query = createQuery(state);</span><br><span class="line">        query.with(page.getSort());</span><br><span class="line">        query.skip(page.getSkip()).limit(page.getPageSize());// 从skip开始,取多少条记录  </span><br><span class="line"></span><br><span class="line">        return this.find(query);  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long findCount(Integer state)&#123;</span><br><span class="line">        Query query = createQuery(state);</span><br><span class="line">        return this.findCount(query);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Query createQuery(Integer state)&#123;</span><br><span class="line">        Query query = new Query();</span><br><span class="line">        query.addCriteria(Criteria.where(&quot;state&quot;).is(state));  </span><br><span class="line">        return query;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Article findOneByLinkOrTitle(String link, String title) &#123;</span><br><span class="line">        Query query = new Query(</span><br><span class="line">                new Criteria().orOperator(Criteria.where(&quot;title&quot;).is(title),    Criteria.where(&quot;link&quot;).is(link))</span><br><span class="line">                );</span><br><span class="line">        return getMongoTemplate().findOne(query, Article.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分页辅助类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api.util;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.springframework.data.domain.Sort;</span><br><span class="line">import org.springframework.data.domain.Sort.Direction;</span><br><span class="line"></span><br><span class="line">import ren.benben.diary.api.constant.Constant;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 分页辅助类</span><br><span class="line"> * @ClassName: Pagination </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟 </span><br><span class="line"> * @date 2015年8月10日 下午4:15:51 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class Pagination &#123;</span><br><span class="line">    /** 每页数量 */</span><br><span class="line">    private Integer pageSize;</span><br><span class="line">    /** 开始位置 */</span><br><span class="line">    private Integer skip;</span><br><span class="line">    /** 当前页 */</span><br><span class="line">    private Integer currentPage;</span><br><span class="line">    /** 总页数 */</span><br><span class="line">    private Long totalPage;</span><br><span class="line">    /** 查询到的总数据量 */</span><br><span class="line">    private Long totalNumber;</span><br><span class="line">    /** 数据集 */</span><br><span class="line">    private List items;</span><br><span class="line">    /** 排序 */</span><br><span class="line">    private Sort sort;</span><br><span class="line"></span><br><span class="line">    public Pagination(int currentPage, Long totalNumber) &#123;</span><br><span class="line">        this.pageSize = Constant.PAGE_SIZE;</span><br><span class="line">        this.currentPage = currentPage;</span><br><span class="line">        this.totalNumber = totalNumber;</span><br><span class="line">        this.totalPage = totalNumber / pageSize + 1;</span><br><span class="line">        this.skip = (currentPage - 1) * pageSize;</span><br><span class="line">        this.sort = new Sort(new Sort.Order(Direction.ASC, &quot;_id&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getCurrentPage() &#123;</span><br><span class="line">        return currentPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setCurrentPage(Integer currentPage) &#123;</span><br><span class="line">        this.currentPage = currentPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long getTotalPage() &#123;</span><br><span class="line">        return totalPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTotalPage(Long totalPage) &#123;</span><br><span class="line">        this.totalPage = totalPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Long getTotalNumber() &#123;</span><br><span class="line">        return totalNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTotalNumber(Long totalNumber) &#123;</span><br><span class="line">        this.totalNumber = totalNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List getItems() &#123;</span><br><span class="line">        return items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setItems(List items) &#123;</span><br><span class="line">        this.items = items;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getPageSize() &#123;</span><br><span class="line">        return pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPageSize(Integer pageSize) &#123;</span><br><span class="line">        this.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getSkip() &#123;</span><br><span class="line">        return skip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSkip(Integer skip) &#123;</span><br><span class="line">        this.skip = skip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Sort getSort() &#123;</span><br><span class="line">        return sort;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSort(String dir, boolean isAsc) &#123;</span><br><span class="line">        if (isAsc) &#123;</span><br><span class="line">            this.sort = new Sort(new Sort.Order(Direction.ASC, dir));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.sort = new Sort(new Sort.Order(Direction.DESC, dir));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5、测试及小优化"><a href="#5、测试及小优化" class="headerlink" title="5、测试及小优化"></a>5、测试及小优化</h2><h2 id="5-1-测试数据插入及-class属性的移除"><a href="#5-1-测试数据插入及-class属性的移除" class="headerlink" title="5.1 测试数据插入及_class属性的移除"></a>5.1 测试数据插入及_class属性的移除</h2><p>单元测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package diary;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import org.junit.Test;</span><br><span class="line">import org.junit.runner.RunWith;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.test.context.ContextConfiguration;</span><br><span class="line">import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line">import ren.benben.diary.api.util.DateFactory;</span><br><span class="line">import ren.benben.diary.article.dao.IArticleDao;</span><br><span class="line">import ren.benben.diary.article.model.Article;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@ContextConfiguration(locations = &quot;classpath:/applicationContext.xml&quot;)</span><br><span class="line">public class MongoTest &#123;</span><br><span class="line">    @Autowired private IArticleDao articleDao;</span><br><span class="line">    @Autowired private DateFactory factory;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testInsert()&#123;   </span><br><span class="line">        try &#123;</span><br><span class="line">            Article article = new Article();</span><br><span class="line">            article.setTitle(&quot;标题1&quot;);</span><br><span class="line">            article.setLink(&quot;http://benben.ren&quot;);</span><br><span class="line">            article.setState(1);</span><br><span class="line">            article.setCreateTime(factory.now());</span><br><span class="line">            articleDao.insert(article);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试结果：<br><img src="/img/article/20150810162151697.png" alt="这里写图片描述"></p>
<p>我们看到测试结果中，除了我们想要保存的属性值外，还多了一个_class的属性。这是由Spring默认帮我们加到集合中的。它可能并不是我们需要的，且这个数据还占着存储空间。如果我们想把这个属性去掉，可以通过配置MappingMongoConverter的typeMapper来实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;mappingContext&quot;</span><br><span class="line">        class=&quot;org.springframework.data.mongodb.core.mapping.MongoMappingContext&quot; /&gt;</span><br><span class="line">    &lt;!-- 默认Mongodb类型映射 --&gt;</span><br><span class="line">    &lt;bean id=&quot;defaultMongoTypeMapper&quot;</span><br><span class="line">        class=&quot;org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper&quot;&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;typeKey&quot;&gt;</span><br><span class="line">            &lt;null /&gt;&lt;!-- 这里设置为空,可以把 spring data mongodb 多余保存的_class字段去掉 --&gt;</span><br><span class="line">        &lt;/constructor-arg&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;bean id=&quot;mappingMongoConverter&quot;</span><br><span class="line">        class=&quot;org.springframework.data.mongodb.core.convert.MappingMongoConverter&quot;&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot; /&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;mappingContext&quot; ref=&quot;mappingContext&quot; /&gt;</span><br><span class="line">        &lt;property name=&quot;typeMapper&quot; ref=&quot;defaultMongoTypeMapper&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- mongodb的主要操作对象，所有对mongodb的增删改查的操作都是通过它完成 --&gt;</span><br><span class="line">    &lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot;&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot; /&gt;</span><br><span class="line">        &lt;constructor-arg name=&quot;mongoConverter&quot; ref=&quot;mappingMongoConverter&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-2-测试简单查询及类型转换器"><a href="#5-2-测试简单查询及类型转换器" class="headerlink" title="5.2 测试简单查询及类型转换器"></a>5.2 测试简单查询及类型转换器</h2><p>单元测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testFindOne() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Article article = articleDao.findOne(&quot;55c85750a192cfe9d93e1cf1&quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(article.getTitle());</span><br><span class="line">        System.out.println(article.getCreateTime());</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">信息: JSR-330 &apos;javax.inject.Inject&apos; annotation found and supported for autowiring</span><br><span class="line">org.springframework.core.convert.ConverterNotFoundException: No converter found </span><br><span class="line">capable of converting from type java.util.Date to type java.sql.Timestamp</span><br><span class="line">    at org.springframework.core.convert.support.GenericConversionService.handleConv</span><br><span class="line">erterNotFound(GenericConversionService.java:311)</span><br><span class="line">    at org.springframework.core.convert.support.GenericConversionService.convert(Ge</span><br><span class="line">nericConversionService.java:192)</span><br><span class="line">    at org.springframework.core.convert.support.GenericConversionService.convert(Ge</span><br><span class="line">nericConversionService.java:173)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.getPoten</span><br><span class="line">tiallyConvertedSimpleRead(MappingMongoConverter.java:821)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.readValu</span><br><span class="line">e(MappingMongoConverter.java:1187)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.access$2</span><br><span class="line">00(MappingMongoConverter.java:78)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter$MongoDbP</span><br><span class="line">ropertyValueProvider.getPropertyValue(MappingMongoConverter.java:1133)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.getValue</span><br><span class="line">Internal(MappingMongoConverter.java:869)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter$1.doWith</span><br><span class="line">PersistentProperty(MappingMongoConverter.java:282)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter$1.doWith</span><br><span class="line">PersistentProperty(MappingMongoConverter.java:270)</span><br><span class="line">    at org.springframework.data.mapping.model.BasicPersistentEntity.doWithPropertie</span><br><span class="line">s(BasicPersistentEntity.java:309)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.read(Map</span><br><span class="line">pingMongoConverter.java:270)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.read(Map</span><br><span class="line">pingMongoConverter.java:231)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.read(Map</span><br><span class="line">pingMongoConverter.java:191)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.read(Map</span><br><span class="line">pingMongoConverter.java:187)</span><br><span class="line">    at org.springframework.data.mongodb.core.convert.MappingMongoConverter.read(Map</span><br><span class="line">pingMongoConverter.java:78)</span><br><span class="line">    at org.springframework.data.mongodb.core.MongoTemplate$ReadDbObjectCallback.doW</span><br><span class="line">ith(MongoTemplate.java:2200)</span><br><span class="line">    at org.springframework.data.mongodb.core.MongoTemplate.executeFindOneInternal(M</span><br><span class="line">ongoTemplate.java:1837)</span><br><span class="line">    at org.springframework.data.mongodb.core.MongoTemplate.doFindOne(MongoTemplate.</span><br><span class="line">java:1654)</span><br><span class="line">    at org.springframework.data.mongodb.core.MongoTemplate.findOne(MongoTemplate.ja</span><br><span class="line">va:563)</span><br><span class="line">    at org.springframework.data.mongodb.core.MongoTemplate.findOne(MongoTemplate.ja</span><br><span class="line">va:558)</span><br><span class="line">    at ren.benben.diary.api.BaseDao.findOne(BaseDao.java:56)</span><br><span class="line">    at diary.MongoTest.testFindOne(MongoTest.java:41)</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57</span><br><span class="line">)</span><br><span class="line">    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl</span><br><span class="line">.java:43)</span><br><span class="line">    at java.lang.reflect.Method.invoke(Method.java:606)</span><br><span class="line">    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.</span><br><span class="line">java:50)</span><br><span class="line">    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.j</span><br><span class="line">ava:12)</span><br><span class="line">    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.ja</span><br><span class="line">va:47)</span><br><span class="line">    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.jav</span><br><span class="line">a:17)</span><br><span class="line">    at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallba</span><br><span class="line">cks.evaluate(RunBeforeTestMethodCallbacks.java:72)</span><br><span class="line">    at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbac</span><br><span class="line">ks.evaluate(RunAfterTestMethodCallbacks.java:81)</span><br><span class="line">    at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(Spr</span><br><span class="line">ingRepeat.java:72)</span><br><span class="line">    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)</span><br><span class="line">    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(Spr</span><br><span class="line">ingJUnit4ClassRunner.java:216)</span><br><span class="line">    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(Spr</span><br><span class="line">ingJUnit4ClassRunner.java:82)</span><br><span class="line">    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)</span><br><span class="line">    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)</span><br><span class="line">    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)</span><br><span class="line">    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)</span><br><span class="line">    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)</span><br><span class="line">    at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbac</span><br><span class="line">ks.evaluate(RunBeforeTestClassCallbacks.java:60)</span><br><span class="line">    at org.springframework.test.context.junit4.statements.RunAfterTestClassCallback</span><br><span class="line">s.evaluate(RunAfterTestClassCallbacks.java:67)</span><br><span class="line">    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)</span><br><span class="line">    at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJU</span><br><span class="line">nit4ClassRunner.java:162)</span><br><span class="line">    at org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestRef</span><br><span class="line">erence.java:50)</span><br><span class="line">    at org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:3</span><br><span class="line">8)</span><br><span class="line">    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRu</span><br><span class="line">nner.java:459)</span><br><span class="line">    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRu</span><br><span class="line">nner.java:675)</span><br><span class="line">    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.</span><br><span class="line">java:382)</span><br><span class="line">    at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner</span><br><span class="line">.java:192)</span><br></pre></td></tr></table></figure></p>
<p>这里报无法将java.util.Date转换成java.sql.Timestamp。原因是我们实体类中的时间是Timestamp类型的，而Spring Data默认的时间类型是Date。<br>这里我们需要一个转换器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package ren.benben.diary.api.converter;</span><br><span class="line"></span><br><span class="line">import java.sql.Timestamp;</span><br><span class="line">import java.util.Date;</span><br><span class="line"></span><br><span class="line">import org.springframework.core.convert.converter.Converter;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Timestamp转换器</span><br><span class="line"> * 将Date转换成Timestamp</span><br><span class="line"> * @ClassName: TimestampConverter </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 笨笨 </span><br><span class="line"> * @date 2015年8月10日 下午4:45:19 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class TimestampConverter implements Converter&lt;Date, Timestamp&gt;&#123;</span><br><span class="line"></span><br><span class="line">    public Timestamp convert(Date date) &#123;</span><br><span class="line">        if(date != null)&#123;</span><br><span class="line">            return new Timestamp(date.getTime());</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置TimestampConverter转换器到Spring中。由于我们在上面做移除_class属性优化的时候，使用到了MappingMongoConverter，而MongoTemplate只有一个mongoConverter属性，所以我们需要将DefaultMongoTypeMapper引入新的Converter中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 默认Mongodb类型映射 --&gt;</span><br><span class="line">&lt;bean id=&quot;defaultMongoTypeMapper&quot; class=&quot;org.springframework.data.mongodb.core.convert.DefaultMongoTypeMapper&quot;&gt;</span><br><span class="line">    &lt;constructor-arg name=&quot;typeKey&quot;&gt;</span><br><span class="line">        &lt;null /&gt;&lt;!-- 这里设置为空,可以把 spring data mongodb 多余保存的_class字段去掉 --&gt;</span><br><span class="line">    &lt;/constructor-arg&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- 转换器：1、去掉write的_class字段 2、TimestampConverter --&gt;</span><br><span class="line">&lt;mongo:mapping-converter id=&quot;mongoConverter&quot; base-package=&quot;ren.benben.diary.api.converter&quot; type-mapper-ref=&quot;defaultMongoTypeMapper&quot;&gt;</span><br><span class="line">    &lt;mongo:custom-converters&gt;</span><br><span class="line">      &lt;mongo:converter&gt;</span><br><span class="line">            &lt;bean class=&quot;ren.benben.diary.api.converter.TimestampConverter&quot; /&gt;</span><br><span class="line">      &lt;/mongo:converter&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/mongo:custom-converters&gt;</span><br><span class="line">&lt;/mongo:mapping-converter&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- mongodb的主要操作对象，所有对mongodb的增删改查的操作都是通过它完成 --&gt;  </span><br><span class="line">&lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot;&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot; /&gt;  </span><br><span class="line">    &lt;constructor-arg name=&quot;mongoConverter&quot; ref=&quot;mongoConverter&quot; /&gt;  </span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>再次测试得到结果：<br><img src="/img/article/20150810165548190.png" alt="这里写图片描述"></p>
<h2 id="5-3-使用分页查询"><a href="#5-3-使用分页查询" class="headerlink" title="5.3 使用分页查询"></a>5.3 使用分页查询</h2><p>使用代码（Service层使用）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public Pagination findArticles(Integer currentPage, Integer state) &#123;</span><br><span class="line">    Long count = articleDao.findCount(state);</span><br><span class="line">    Pagination page = new Pagination(currentPage, count);</span><br><span class="line">    page.setSort(&quot;creatTime&quot;, false);</span><br><span class="line"></span><br><span class="line">    page.setItems(articleDao.findListByPage(page, state));</span><br><span class="line"></span><br><span class="line">    return page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里是获取文章总数，获取currentPage页count条数据。并按creatTime降序排序。<br>具体就不详细展开了。</p>
<h2 id="5-4-注意"><a href="#5-4-注意" class="headerlink" title="5.4 注意"></a>5.4 注意</h2><p>BaseDao中做更新数据的时候，我们使用到了java映射机制来获取实体对象的值，并更新这些值。如果更新的属性值不是太多的话，建议不要使用BaseDao的update(T entity)方法，因为通过映射获取值没有直接获取来得快。</p>
<h2 id="6、链接"><a href="#6、链接" class="headerlink" title="6、链接"></a>6、链接</h2><p>Mongodb的简单使用：<br><a href="http://blog.csdn.net/jrainbow/article/details/39163843" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/39163843</a></p>
<p>Spring MVC的简单用法：<br> <a href="http://blog.csdn.net/jrainbow/article/details/46618077" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/46618077</a></p>
<p>HibernateTemplate与HibernateDaoSupport：<br><a href="http://blog.csdn.net/jrainbow/article/details/10526617" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/10526617</a></p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.4" async></script><a data-url="http://ibenben.org/2015/08/10/47400237/" data-id="cjozgqngz004i6gv8dury8nin" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2015/09/22/48652205/" class="pre">Java中的常量：如何避免反模式</a><a href="/2015/07/01/46709715/" class="next">Spring MVC文件上传</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>