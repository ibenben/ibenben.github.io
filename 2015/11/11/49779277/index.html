<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>XStream双下划线问题解决与CDATA标记同时的方案 | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">XStream双下划线问题解决与CDATA标记同时的方案</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">XStream双下划线问题解决与CDATA标记同时的方案</h1><div class="post-meta">Nov 11, 2015<span> | </span><span class="category"><a href="/categories/开发问题解决/">开发问题解决</a><a href="/categories/开发问题解决/Java相关/">Java相关</a><a href="/categories/开发问题解决/Java相关/微信开发/">微信开发</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="1、问题"><a href="#1、问题" class="headerlink" title="1、问题"></a>1、问题</h2><p>在微信开发过程中，需要进行xml格式的数据传输。有些微信接口的xml数据中需要加上CDATA标记，而大部分的xml数据的标签名都带有下划线。注意，微信接口中的数据是有下划线的，是“_”不是“-”，让我很郁闷。</p>
<h2 id="2、使用XStream把Java对象转成xml格式的数据"><a href="#2、使用XStream把Java对象转成xml格式的数据" class="headerlink" title="2、使用XStream把Java对象转成xml格式的数据"></a>2、使用XStream把Java对象转成xml格式的数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">UnifiedOrder unifiedOrder = new UnifiedOrder();</span><br><span class="line">unifiedOrder.setAppid(&quot;123456&quot;);</span><br><span class="line">unifiedOrder.setAttach(&quot;hehedesk&quot;);</span><br><span class="line">unifiedOrder.setBody(&quot;hehedesk&quot;);</span><br><span class="line">unifiedOrder.setOpenid(&quot;5654675&quot;);</span><br><span class="line">unifiedOrder.setSign(&quot;0000000000000000&quot;);</span><br><span class="line">XStream stream = new XStream();</span><br><span class="line">stream.alias(&quot;xml&quot;, unifiedOrder.getClass());</span><br><span class="line">String xml = stream.toXML(unifiedOrder);</span><br><span class="line">System.out.println(xml);</span><br></pre></td></tr></table></figure>
<p>输出XML为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;appid&gt;123456&lt;/appid&gt;</span><br><span class="line">  &lt;attach&gt;hehedesk&lt;/attach&gt;</span><br><span class="line">  &lt;body&gt;hehedesk&lt;/body&gt;</span><br><span class="line">  &lt;openid&gt;5654675&lt;/openid&gt;</span><br><span class="line">  &lt;sign&gt;0000000000000000&lt;/sign&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="3、为数据加上CDATA标记"><a href="#3、为数据加上CDATA标记" class="headerlink" title="3、为数据加上CDATA标记"></a>3、为数据加上CDATA标记</h2><p>修改XStream的实现就可以。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">XStream stream = new XStream(new XppDriver(new NoNameCoder()) &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public HierarchicalStreamWriter createWriter(Writer out) &#123;</span><br><span class="line">            return new PrettyPrintWriter(out) &#123;</span><br><span class="line">                // 对所有xml节点的转换都增加CDATA标记</span><br><span class="line">                boolean cdata = true;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                @SuppressWarnings(&quot;rawtypes&quot;)</span><br><span class="line">                public void startNode(String name, Class clazz) &#123;</span><br><span class="line">                    super.startNode(name, clazz);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                protected void writeText(QuickWriter writer, String text) &#123;</span><br><span class="line">                    if (cdata) &#123;</span><br><span class="line">                        writer.write(&quot;&lt;![CDATA[&quot;);</span><br><span class="line">                        writer.write(text);</span><br><span class="line">                        writer.write(&quot;]]&gt;&quot;);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        writer.write(text);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>输出XML为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;appid&gt;&lt;![CDATA[123456]]&gt;&lt;/appid&gt;</span><br><span class="line">  &lt;attach&gt;&lt;![CDATA[hehedesk]]&gt;&lt;/attach&gt;</span><br><span class="line">  &lt;body&gt;&lt;![CDATA[hehedesk]]&gt;&lt;/body&gt;</span><br><span class="line">  &lt;openid&gt;&lt;![CDATA[5654675]]&gt;&lt;/openid&gt;</span><br><span class="line">  &lt;sign&gt;&lt;![CDATA[0000000000000000]]&gt;&lt;/sign&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、当对象属性带下划线时，XStream转换成双下划线"><a href="#4、当对象属性带下划线时，XStream转换成双下划线" class="headerlink" title="4、当对象属性带下划线时，XStream转换成双下划线"></a>4、当对象属性带下划线时，XStream转换成双下划线</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">UnifiedOrder unifiedOrder = new UnifiedOrder();</span><br><span class="line">unifiedOrder.setAppid(&quot;123456&quot;);</span><br><span class="line">unifiedOrder.setAttach(&quot;hehedesk&quot;);</span><br><span class="line">unifiedOrder.setBody(&quot;hehedesk&quot;);</span><br><span class="line">unifiedOrder.setOpenid(&quot;5654675&quot;);</span><br><span class="line">unifiedOrder.setSign(&quot;0000000000000000&quot;);</span><br><span class="line">unifiedOrder.setMch_id(&quot;123456&quot;);</span><br><span class="line">XStream stream = new XStream();</span><br><span class="line">stream.alias(&quot;xml&quot;, unifiedOrder.getClass());</span><br><span class="line">String xml = stream.toXML(unifiedOrder);</span><br></pre></td></tr></table></figure>
<p>输出XML：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;appid&gt;123456&lt;/appid&gt;</span><br><span class="line">  &lt;mch__id&gt;123456&lt;/mch__id&gt;</span><br><span class="line">  &lt;attach&gt;hehedesk&lt;/attach&gt;</span><br><span class="line">  &lt;body&gt;hehedesk&lt;/body&gt;</span><br><span class="line">  &lt;openid&gt;5654675&lt;/openid&gt;</span><br><span class="line">  &lt;sign&gt;0000000000000000&lt;/sign&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure></p>
<p>注意：这里mch_id的下线线由XStream转成了”__”。</p>
<p>度娘上找到的解决方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new DomDriver(null,new XmlFriendlyNameCoder(&quot;_-&quot;, &quot;_&quot;))</span><br></pre></td></tr></table></figure></p>
<p>经过测试，XmlFriendlyNameCoder与XppDriver不能同时存在。so，问题来了。如何才能让两者共存呢。</p>
<h2 id="5、双下划线问题解决与CDATA标记同时的方案"><a href="#5、双下划线问题解决与CDATA标记同时的方案" class="headerlink" title="5、双下划线问题解决与CDATA标记同时的方案"></a>5、双下划线问题解决与CDATA标记同时的方案</h2><p>双下划线问题的产生是因为XStream默认的转换方式中定义了对特殊字符的转换，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//XmlFriendlyNameCoder.encodeName(String name)</span><br><span class="line">for (; i &lt; length; i++ ) &#123;</span><br><span class="line">            char c = name.charAt(i);</span><br><span class="line">            if (c == &apos;$&apos; || c == &apos;_&apos; || c &lt;= 27 || c &gt;= 127) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是说，我们在转换的过程中，不对特殊字符进行转换就可以了。</p>
<p>XppDriver类中有对字符转换的方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Encode the node name into the name of the target format.</span><br><span class="line"> * </span><br><span class="line"> * @param name the original name</span><br><span class="line"> * @return the name in the target format</span><br><span class="line"> * @since 1.4</span><br><span class="line"> */</span><br><span class="line">public String encodeNode(String name) &#123;</span><br><span class="line">    return nameCoder.encodeNode(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里可以看到，XppDriver的encodeNode是把节点的名称进行格式化。然后调用nameCoder对象对名字进行编译。</p>
<p>我们在XppDriver的子类中，重写此方法，不再像XppDriver那样调用nameCoder来进行编译，而是直接返回节点名称。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public String encodeNode(String name) &#123;</span><br><span class="line">    return name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">XStream stream = new XStream(new XppDriver(new NoNameCoder()) &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public HierarchicalStreamWriter createWriter(Writer out) &#123;</span><br><span class="line">        return new PrettyPrintWriter(out) &#123;</span><br><span class="line">            // 对所有xml节点的转换都增加CDATA标记</span><br><span class="line">            boolean cdata = true;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            @SuppressWarnings(&quot;rawtypes&quot;)</span><br><span class="line">            public void startNode(String name, Class clazz) &#123;</span><br><span class="line">                super.startNode(name, clazz);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public String encodeNode(String name) &#123;</span><br><span class="line">                return name;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            protected void writeText(QuickWriter writer, String text) &#123;</span><br><span class="line">                if (cdata) &#123;</span><br><span class="line">                    writer.write(&quot;&lt;![CDATA[&quot;);</span><br><span class="line">                    writer.write(text);</span><br><span class="line">                    writer.write(&quot;]]&gt;&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    writer.write(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>输出XML:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;xml&gt;</span><br><span class="line">  &lt;appid&gt;&lt;![CDATA[123456]]&gt;&lt;/appid&gt;</span><br><span class="line">  &lt;mch_id&gt;&lt;![CDATA[1111111]]&gt;&lt;/mch_id&gt;</span><br><span class="line">  &lt;attach&gt;&lt;![CDATA[hehedesk]]&gt;&lt;/attach&gt;</span><br><span class="line">  &lt;body&gt;&lt;![CDATA[hehedesk]]&gt;&lt;/body&gt;</span><br><span class="line">  &lt;openid&gt;&lt;![CDATA[5654675]]&gt;&lt;/openid&gt;</span><br><span class="line">  &lt;trade_type&gt;&lt;![CDATA[JSAPI]]&gt;&lt;/trade_type&gt;</span><br><span class="line">  &lt;sign&gt;&lt;![CDATA[0000000000000000]]&gt;&lt;/sign&gt;</span><br><span class="line">  &lt;device_info&gt;&lt;![CDATA[WEB]]&gt;&lt;/device_info&gt;</span><br><span class="line">&lt;/xml&gt;</span><br></pre></td></tr></table></figure></p>
</div><div class="tags"><a href="/tags/微信/">微信</a><a href="/tags/xml/">xml</a><a href="/tags/XStream/">XStream</a><a href="/tags/CDATA/">CDATA</a><a href="/tags/下划线/">下划线</a></div><div class="post-nav"><a href="/2015/11/18/49904065/" class="pre">Java微信开发之公众号支付接口</a><a href="/2015/10/10/49026365/" class="next">Windows平台下tomcat+java的web程序持续占cpu问题调试</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>