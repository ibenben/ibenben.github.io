<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java微信开发之公众号支付接口 | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java微信开发之公众号支付接口</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java微信开发之公众号支付接口</h1><div class="post-meta">Nov 18, 2015<span> | </span><span class="category"><a href="/categories/微信开发/">微信开发</a><a href="/categories/微信开发/Java相关/">Java相关</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="1、设置支付路径"><a href="#1、设置支付路径" class="headerlink" title="1、设置支付路径"></a>1、设置支付路径</h2><p>使用微信公众号支付接口，必须在微信公众号管理后台中设置支付路径。这个微信接口文档说得很清楚，请参考：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_3</a></p>
<h2 id="2、公众号支付业务流程"><a href="#2、公众号支付业务流程" class="headerlink" title="2、公众号支付业务流程"></a>2、公众号支付业务流程</h2><p><img src="/img/article/20151118104919652.png" alt="这里写图片描述"></p>
<p>简单的描述就是：</p>
<p>首先需要根据我们自己的订单（4），也就是需要支付的明细，然后使用统一下单API向微信请求生成微信看得懂的订单（5），然后生成支付参数及签名（6），在支付页面根据支付配置及微信统一订单的prepay_id，发起微信支付（7）。用户输入密码支付后，微信会通过异步的方式，通知我们的系统，告诉支付的结果（10）。我们在系统后台处理根据支付的结果，处理我们的业务后，返回信息告诉向往，此订单已确定（11）。</p>
<h2 id="3、统一下单"><a href="#3、统一下单" class="headerlink" title="3、统一下单"></a>3、统一下单</h2><p>我们生成订单后，通过统一下单API，把微信的订单与我们的订单关联起来。</p>
<p>微信的统一下单接口：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1</a></p>
<p>统一订单实体类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">package com.benben.timetable.wechat.entity;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 统一下单</span><br><span class="line"> * </span><br><span class="line"> * @ClassName: UnifiedOrder</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2015年9月18日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class UnifiedOrder &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 公众账号ID</span><br><span class="line">     */</span><br><span class="line">    private String appid;</span><br><span class="line">    /**</span><br><span class="line">     * 商户号</span><br><span class="line">     */</span><br><span class="line">    private String mch_id;</span><br><span class="line">    /**</span><br><span class="line">     * 附加数据(说明)</span><br><span class="line">     */</span><br><span class="line">    private String attach;</span><br><span class="line">    /**</span><br><span class="line">     * 商品描述</span><br><span class="line">     */</span><br><span class="line">    private String body;</span><br><span class="line">    /**</span><br><span class="line">     * 随机串</span><br><span class="line">     */</span><br><span class="line">    private String nonce_str;</span><br><span class="line">    /**</span><br><span class="line">     * 通知地址</span><br><span class="line">     */</span><br><span class="line">    private String notify_url;</span><br><span class="line">    /**</span><br><span class="line">     * 用户标识</span><br><span class="line">     */</span><br><span class="line">    private String openid;</span><br><span class="line">    /**</span><br><span class="line">     * 商户订单号</span><br><span class="line">     */</span><br><span class="line">    private String out_trade_no;</span><br><span class="line">    /**</span><br><span class="line">     * 终端IP（用户）</span><br><span class="line">     */</span><br><span class="line">    private String spbill_create_ip;</span><br><span class="line">    /**</span><br><span class="line">     * 总金额</span><br><span class="line">     */</span><br><span class="line">    private Integer total_fee;</span><br><span class="line">    /**</span><br><span class="line">     * 交易类型</span><br><span class="line">     */</span><br><span class="line">    private String trade_type;</span><br><span class="line">    /**</span><br><span class="line">     * 签名</span><br><span class="line">     */</span><br><span class="line">    private String sign;</span><br><span class="line">    /**</span><br><span class="line">     * WEB</span><br><span class="line">     */</span><br><span class="line">    private String device_info;</span><br><span class="line"></span><br><span class="line">    public UnifiedOrder()&#123;</span><br><span class="line">        this.trade_type = &quot;JSAPI&quot;;</span><br><span class="line">        this.device_info = &quot;WEB&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAppid() &#123;</span><br><span class="line">        return appid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAppid(String appid) &#123;</span><br><span class="line">        this.appid = appid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAttach() &#123;</span><br><span class="line">        return attach;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAttach(String attach) &#123;</span><br><span class="line">        this.attach = attach;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getBody() &#123;</span><br><span class="line">        return body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setBody(String body) &#123;</span><br><span class="line">        this.body = body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getMch_id() &#123;</span><br><span class="line">        return mch_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setMch_id(String mch_id) &#123;</span><br><span class="line">        this.mch_id = mch_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getNonce_str() &#123;</span><br><span class="line">        return nonce_str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNonce_str(String nonce_str) &#123;</span><br><span class="line">        this.nonce_str = nonce_str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getNotify_url() &#123;</span><br><span class="line">        return notify_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNotify_url(String notify_url) &#123;</span><br><span class="line">        this.notify_url = notify_url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getOpenid() &#123;</span><br><span class="line">        return openid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOpenid(String openid) &#123;</span><br><span class="line">        this.openid = openid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getOut_trade_no() &#123;</span><br><span class="line">        return out_trade_no;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOut_trade_no(String out_trade_no) &#123;</span><br><span class="line">        this.out_trade_no = out_trade_no;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSpbill_create_ip() &#123;</span><br><span class="line">        return spbill_create_ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSpbill_create_ip(String spbill_create_ip) &#123;</span><br><span class="line">        this.spbill_create_ip = spbill_create_ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Integer getTotal_fee() &#123;</span><br><span class="line">        return total_fee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTotal_fee(Integer total_fee) &#123;</span><br><span class="line">        this.total_fee = total_fee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTrade_type() &#123;</span><br><span class="line">        return trade_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTrade_type(String trade_type) &#123;</span><br><span class="line">        this.trade_type = trade_type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSign() &#123;</span><br><span class="line">        return sign;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSign(String sign) &#123;</span><br><span class="line">        this.sign = sign;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getDevice_info() &#123;</span><br><span class="line">        return device_info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setDevice_info(String device_info) &#123;</span><br><span class="line">        this.device_info = device_info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>统一下单代码中使用到的参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 应用编号（微信公众号编号）</span><br><span class="line"> */</span><br><span class="line">private @Value(&quot;$&#123;app_id&#125;&quot;) String appId;</span><br><span class="line">/**</span><br><span class="line"> * 商户号码</span><br><span class="line"> */</span><br><span class="line">private @Value(&quot;$&#123;mch_id&#125;&quot;) String mchId;</span><br><span class="line">/**</span><br><span class="line"> * 支付码</span><br><span class="line"> */</span><br><span class="line">private @Value(&quot;$&#123;pay_key&#125;&quot;) String payKey;</span><br><span class="line">/**</span><br><span class="line"> * 统一下单URL</span><br><span class="line"> */</span><br><span class="line">private @Value(&quot;$&#123;pay_unifiedorder_url&#125;&quot;) String unifiedOrderUrl;</span><br></pre></td></tr></table></figure></p>
<p>统一下单，并返回获取prepay_id:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 统一下单</span><br><span class="line"> * @Title: unifiedOrder </span><br><span class="line"> * @Description: TODO </span><br><span class="line"> * @param: @param openId 微信用户openId</span><br><span class="line"> * @param: @param orderId 订单ID</span><br><span class="line"> * @param: @param money 订单总价，单位：分</span><br><span class="line"> * @param: @param callbackUrl 回调路径</span><br><span class="line"> * @param: @return</span><br><span class="line"> * @param: @throws Exception</span><br><span class="line"> * @return: String</span><br><span class="line"> */</span><br><span class="line">public String unifiedOrder(String openId,String orderId,int money,String callbackUrl) throws Exception&#123;</span><br><span class="line">    UnifiedOrder unifiedOrder = new UnifiedOrder();</span><br><span class="line">    unifiedOrder.setAppid(appId);</span><br><span class="line">    unifiedOrder.setAttach(&quot;hehedesk&quot;);</span><br><span class="line"></span><br><span class="line">    unifiedOrder.setBody(&quot;hehedesk&quot;);</span><br><span class="line">    unifiedOrder.setMch_id(mchId);</span><br><span class="line"></span><br><span class="line">    String nonce = UUID.randomUUID().toString().substring(0, 30);</span><br><span class="line">    unifiedOrder.setNonce_str(nonce);</span><br><span class="line">    unifiedOrder.setNotify_url(callbackUrl);</span><br><span class="line"></span><br><span class="line">    unifiedOrder.setOpenid(openId);</span><br><span class="line">    unifiedOrder.setOut_trade_no(orderId);</span><br><span class="line"></span><br><span class="line">    unifiedOrder.setSpbill_create_ip(&quot;14.23.150.211&quot;);</span><br><span class="line">    unifiedOrder.setTotal_fee(money);</span><br><span class="line"></span><br><span class="line">    String sign = createUnifiedOrderSign(unifiedOrder);</span><br><span class="line">    unifiedOrder.setSign(sign);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 转成XML格式</span><br><span class="line">     */</span><br><span class="line">    xmlUtil.getXstreamInclueUnderline().alias(&quot;xml&quot;, unifiedOrder.getClass());</span><br><span class="line">    String xml = xmlUtil.getXstreamInclueUnderline().toXML(unifiedOrder);</span><br><span class="line"></span><br><span class="line">    String response = httpConnection.post(unifiedOrderUrl, xml);</span><br><span class="line">    logger.info(&quot;unifiedOrder&quot;);</span><br><span class="line">    logger.info(response);</span><br><span class="line">    Map&lt;String, String&gt; responseMap = xmlUtil.parseXml(response);</span><br><span class="line"></span><br><span class="line">    return responseMap.get(&quot;prepay_id&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>openid相关介绍：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_4" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_4</a></p>
<p>实体对象转XML介绍：<a href="http://blog.csdn.net/jrainbow/article/details/49779277" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/49779277</a></p>
<p>关联我们的订单与微信订单的prepay_id:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String url = &quot;http://letus.xyz/mall/order/wechat_notify&quot;;</span><br><span class="line">String prepayId = wechatMerchantFactory.unifiedOrder(order.getUser().getOpenId(), order.getId(), (int) (100*order.getTotal()),url );</span><br><span class="line">order.setPrepayId(prepayId);</span><br></pre></td></tr></table></figure></p>
<p>回调路径callbackUrl是指支付成功后，微信向我们系统服务器回复支付结果信息的路径。支付成功后的订单处理逻辑一这个路径中写。</p>
<p>关联了订单与prepay_id后，我们就可以使用prepay_id来获取我们的订单及处理后续业务。</p>
<p>统一下单的签名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取统一下单签名</span><br><span class="line"> * @Title: createUnifiedOrderSign</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param unifiedOrder</span><br><span class="line"> * @param @return    </span><br><span class="line"> * @return String    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public String createUnifiedOrderSign(UnifiedOrder unifiedOrder)&#123;</span><br><span class="line">    StringBuffer sign = new StringBuffer();</span><br><span class="line">    sign.append(&quot;appid=&quot;).append(unifiedOrder.getAppid());</span><br><span class="line">    sign.append(&quot;&amp;attach=&quot;).append(unifiedOrder.getAttach());</span><br><span class="line">    sign.append(&quot;&amp;body=&quot;).append(unifiedOrder.getBody());</span><br><span class="line">    sign.append(&quot;&amp;device_info=&quot;).append(unifiedOrder.getDevice_info());</span><br><span class="line">    sign.append(&quot;&amp;mch_id=&quot;).append(unifiedOrder.getMch_id());</span><br><span class="line">    sign.append(&quot;&amp;nonce_str=&quot;).append(unifiedOrder.getNonce_str());</span><br><span class="line">    sign.append(&quot;&amp;notify_url=&quot;).append(unifiedOrder.getNotify_url());</span><br><span class="line">    sign.append(&quot;&amp;openid=&quot;).append(unifiedOrder.getOpenid());</span><br><span class="line">    sign.append(&quot;&amp;out_trade_no=&quot;).append(unifiedOrder.getOut_trade_no());</span><br><span class="line">    sign.append(&quot;&amp;spbill_create_ip=&quot;).append(unifiedOrder.getSpbill_create_ip());</span><br><span class="line">    sign.append(&quot;&amp;total_fee=&quot;).append(unifiedOrder.getTotal_fee());</span><br><span class="line">    sign.append(&quot;&amp;trade_type=&quot;).append(unifiedOrder.getTrade_type());</span><br><span class="line">    sign.append(&quot;&amp;key=&quot;).append(payKey);</span><br><span class="line"></span><br><span class="line">    return DigestUtils.md5Hex(sign.toString()).toUpperCase();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>签名算法请参考：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_3" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=4_3</a></p>
<p>签名特别注意以下重要规则（微信文档中也有）：<br>◆ 参数名ASCII码从小到大排序（字典序）；<br>◆ 如果参数的值为空不参与签名；<br>◆ 参数名区分大小写；<br>◆ 验证调用返回或微信主动通知签名时，传送的sign参数不参与签名，将生成的签名与该sign值作校验。<br>◆ 微信接口可能增加字段，验证签名时必须支持增加的扩展字段</p>
<p>微信商户相关的开发中，多次用到排序后的字符签名。为了避免多次手写拼接字符串和手动拼接会出现人为的失误，我们可以使用动态对对象的属性名排序并拼接字符串的方式代替。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * 获取统一下单签名</span><br><span class="line">    * @Title: createUnifiedOrderSign</span><br><span class="line">    * @Description: TODO</span><br><span class="line">    * @param @param unifiedOrder</span><br><span class="line">    * @param @return    </span><br><span class="line">    * @return String    </span><br><span class="line">    * @throws</span><br><span class="line">    */</span><br><span class="line">   public String createUnifiedOrderSign(UnifiedOrder unifiedOrder)&#123;</span><br><span class="line">       StringBuffer sign = new StringBuffer();</span><br><span class="line">       Map&lt;String, String&gt; map = getSortMap(unifiedOrder);</span><br><span class="line"></span><br><span class="line">       boolean isNotFirst = false;</span><br><span class="line"></span><br><span class="line">       for (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">           if(isNotFirst == true)&#123;</span><br><span class="line">               sign.append(&quot;&amp;&quot;);</span><br><span class="line">           &#125;else&#123;</span><br><span class="line">               isNotFirst = true;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           sign.append(entry.getKey()).append(&quot;=&quot;).append(entry.getValue());</span><br><span class="line">       &#125;</span><br><span class="line">       sign.append(&quot;&amp;key=&quot;).append(payKey);</span><br><span class="line"></span><br><span class="line">       return DigestUtils.md5Hex(sign.toString()).toUpperCase();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 获取排序后的类属性及值</span><br><span class="line">    * @param object</span><br><span class="line">    * @return</span><br><span class="line">    * @throws Exception</span><br><span class="line">    */</span><br><span class="line">   private Map&lt;String, String&gt; getSortMap(Object object) throws Exception&#123;</span><br><span class="line">       Field[] fields = object.getClass().getDeclaredFields();</span><br><span class="line">       Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">       for(Field field : fields)&#123;</span><br><span class="line">            String name = field.getName();</span><br><span class="line">            String methodName = &quot;get&quot; + name.replaceFirst(name.substring(0, 1), name.substring(0, 1)</span><br><span class="line">                    .toUpperCase());</span><br><span class="line">            Method getter = object.getClass().getMethod(methodName);</span><br><span class="line">            // 调用getter方法获取属性值</span><br><span class="line">            String value =  getter.invoke(object)+&quot;&quot;;</span><br><span class="line">            if (value != null)&#123;</span><br><span class="line">                map.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Map&lt;String, String&gt; sortMap = new TreeMap&lt;String, String&gt;(</span><br><span class="line">               new Comparator&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                   @Override</span><br><span class="line">                   public int compare(String arg0, String arg1) &#123;</span><br><span class="line"></span><br><span class="line">                       return arg0.compareTo(arg1);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125;);</span><br><span class="line"></span><br><span class="line">       sortMap.putAll(map);</span><br><span class="line"></span><br><span class="line">       return sortMap;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4、网页端调起支付API"><a href="#4、网页端调起支付API" class="headerlink" title="4、网页端调起支付API"></a>4、网页端调起支付API</h2><p>支付相关文档参考：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&amp;index=6" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&amp;index=6</a></p>
<p>4.1、生成支付参数及签名</p>
<p>支付配置实体：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">package com.benben.timetable.wechat.entity;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * JS-SDK使用的配置信息</span><br><span class="line"> * @ClassName: JsAPIConfig </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟 </span><br><span class="line"> * @date 2015年8月17日 下午3:12:35 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class JsAPIConfig &#123;</span><br><span class="line">    private boolean debug;</span><br><span class="line">    private String appId;</span><br><span class="line">    private String timestamp;</span><br><span class="line">    private String nonce;</span><br><span class="line">    private String signature;</span><br><span class="line">    private String title;</span><br><span class="line">    private String link;</span><br><span class="line">    private String signType;</span><br><span class="line">    private String packageName;</span><br><span class="line"></span><br><span class="line">    public JsAPIConfig()&#123;</span><br><span class="line">        signType = &quot;MD5&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isDebug() &#123;</span><br><span class="line">        return debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setDebug(boolean debug) &#123;</span><br><span class="line">        this.debug = debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAppId() &#123;</span><br><span class="line">        return appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAppId(String appId) &#123;</span><br><span class="line">        this.appId = appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTimestamp() &#123;</span><br><span class="line">        return timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTimestamp(String timestamp) &#123;</span><br><span class="line">        this.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getNonce() &#123;</span><br><span class="line">        return nonce;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNonce(String nonce) &#123;</span><br><span class="line">        this.nonce = nonce;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSignature() &#123;</span><br><span class="line">        return signature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSignature(String signature) &#123;</span><br><span class="line">        this.signature = signature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTitle() &#123;</span><br><span class="line">        return title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTitle(String title) &#123;</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getLink() &#123;</span><br><span class="line">        return link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setLink(String link) &#123;</span><br><span class="line">        this.link = link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSignType() &#123;</span><br><span class="line">        return signType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSignType(String signType) &#123;</span><br><span class="line">        this.signType = signType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPackageName() &#123;</span><br><span class="line">        return packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPackageName(String packageName) &#123;</span><br><span class="line">        this.packageName = packageName;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>生成支付配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 获取支付配置</span><br><span class="line"> * @Title: createPayConfig</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param preayId 统一下单prepay_id</span><br><span class="line"> * @param @return</span><br><span class="line"> * @param @throws Exception    </span><br><span class="line"> * @return JsAPIConfig    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public JsAPIConfig createPayConfig(String prepayId) throws Exception &#123;</span><br><span class="line">    JsAPIConfig config = new JsAPIConfig();</span><br><span class="line"></span><br><span class="line">    String nonce = UUID.randomUUID().toString();</span><br><span class="line">    String timestamp = Long.toString(System.currentTimeMillis() / 1000);</span><br><span class="line">    String packageName = &quot;prepay_id=&quot;+prepayId;</span><br><span class="line">    StringBuffer sign = new StringBuffer();</span><br><span class="line">    sign.append(&quot;appId=&quot;).append(appId);</span><br><span class="line">    sign.append(&quot;&amp;nonceStr=&quot;).append(nonce);</span><br><span class="line">    sign.append(&quot;&amp;package=&quot;).append(packageName);</span><br><span class="line">    sign.append(&quot;&amp;signType=&quot;).append(config.getSignType());</span><br><span class="line">    sign.append(&quot;&amp;timeStamp=&quot;).append(timestamp);</span><br><span class="line">    sign.append(&quot;&amp;key=&quot;).append(payKey);</span><br><span class="line">    String signature = DigestUtils.md5Hex(sign.toString()).toUpperCase();</span><br><span class="line"></span><br><span class="line">    config.setAppId(appId);</span><br><span class="line">    config.setNonce(nonce);</span><br><span class="line">    config.setTimestamp(timestamp);</span><br><span class="line">    config.setPackageName(packageName);</span><br><span class="line">    config.setSignature(signature);</span><br><span class="line"></span><br><span class="line">    return config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.2、页面调用JSAPI来进行支付<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$(&apos;#pay-button&apos;).on(&apos;click&apos;,function()&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url:&apos;wechat/mall/pay/&apos;+$(&apos;#prepay_id&apos;).html(),</span><br><span class="line">        type : &quot;get&quot;,</span><br><span class="line">        data : &#123;</span><br><span class="line">            &quot;timestamp&quot; : new Date().getTime()</span><br><span class="line">        &#125;,</span><br><span class="line">        success : function(response) &#123;</span><br><span class="line">            var data = eval(&apos;(&apos; + response + &apos;)&apos;); </span><br><span class="line">            var obj = data.msg;</span><br><span class="line">            WeixinJSBridge.invoke(&apos;getBrandWCPayRequest&apos;,&#123;  </span><br><span class="line">                &quot;appId&quot; : obj.appId,                  //公众号名称，由商户传入  </span><br><span class="line">                &quot;timeStamp&quot;:obj.timestamp,          //时间戳，自 1970 年以来的秒数  </span><br><span class="line">                &quot;nonceStr&quot; : obj.nonce,         //随机串  </span><br><span class="line">                &quot;package&quot; : obj.packageName,      //商品包信息&lt;/span&gt;  </span><br><span class="line">                &quot;signType&quot; : obj.signType,        //微信签名方式</span><br><span class="line">                &quot;paySign&quot; : obj.signature           //微信签名  </span><br><span class="line">                &#125;,function(res)&#123;      </span><br><span class="line"></span><br><span class="line">                if(res.err_msg == &quot;get_brand_wcpay_request:ok&quot; ) &#123;  </span><br><span class="line">                    alert(&apos;支付成功&apos;);  </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);  </span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;);         </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>单点击支付按钮时，首先获取JSAPI需要的配置参数，然后再调用WeixinJSBridge来使用getBrandWCPayRequest请求进行支付。</p>
<h2 id="5、支付结果回调"><a href="#5、支付结果回调" class="headerlink" title="5、支付结果回调"></a>5、支付结果回调</h2><p>当用户输入密码，支付动作完成后。微信会通过前面我们设置的callbackUrl来返回支付结果。</p>
<p>相关资料参考：<a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7" target="_blank" rel="noopener">https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7</a></p>
<p>下面是<a href="http://letus.xyz/mall/order/wechat_notify回调路径的内容：" target="_blank" rel="noopener">http://letus.xyz/mall/order/wechat_notify回调路径的内容：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 微信支付回调页面</span><br><span class="line"> * @Title: wechatPayNotify</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param request</span><br><span class="line"> * @param @param trade_status</span><br><span class="line"> * @param @param out_trade_no</span><br><span class="line"> * @param @param trade_no    </span><br><span class="line"> * @return void    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">@ResponseBody </span><br><span class="line">@RequestMapping(value=&quot;wechat_notify&quot;)</span><br><span class="line">public String wechatPayNotify(HttpServletRequest request)&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">         Map&lt;String, String&gt; map = getCallbackParams(request);</span><br><span class="line">         if (map.get(&quot;result_code&quot;).toString().equalsIgnoreCase(&quot;SUCCESS&quot;)) &#123;</span><br><span class="line">             String orderId = map.get(&quot;out_trade_no&quot;);</span><br><span class="line">             //这里写成功后的业务逻辑</span><br><span class="line">             orderService.updateConfirm(orderId);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return wechatMerchantFactory.getPayCallback(); </span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> * 获取请求参数</span><br><span class="line"> * @Title: getCallbackParams</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param request</span><br><span class="line"> * @param @return</span><br><span class="line"> * @param @throws Exception    </span><br><span class="line"> * @return Map&lt;String,String&gt;    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public Map&lt;String, String&gt; getCallbackParams(HttpServletRequest request)</span><br><span class="line">        throws Exception &#123;</span><br><span class="line">    InputStream inStream = request.getInputStream();</span><br><span class="line">    ByteArrayOutputStream outSteam = new ByteArrayOutputStream();</span><br><span class="line">    byte[] buffer = new byte[1024];</span><br><span class="line">    int len = 0;</span><br><span class="line">    while ((len = inStream.read(buffer)) != -1) &#123;</span><br><span class="line">        outSteam.write(buffer, 0, len);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(&quot;~~~~~~~~~~~~~~~~付款成功~~~~~~~~~&quot;);</span><br><span class="line">    outSteam.close();</span><br><span class="line">    inStream.close();</span><br><span class="line">    String result = new String(outSteam.toByteArray(), &quot;utf-8&quot;);</span><br><span class="line">    return xmlUtil.parseXml(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注：这里的out_trade_no指的不是前面说的prepay_id。而是我们系统中的orderId。</p>
<p>支付结果确认收到后，我们还需要告知微信。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return wechatMerchantFactory.getPayCallback();</span><br></pre></td></tr></table></figure></p>
<p>PayCallback:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package com.benben.timetable.wechat.entity;</span><br><span class="line">/**</span><br><span class="line"> * 支付成功回复</span><br><span class="line"> * @ClassName: PayCallBack</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2015年11月12日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class PayCallback &#123;</span><br><span class="line">    private String return_code;</span><br><span class="line">    private String return_msg;</span><br><span class="line"></span><br><span class="line">    public PayCallback() &#123;</span><br><span class="line">        this.return_code = &quot;SUCCESS&quot;;</span><br><span class="line">        this.return_msg = &quot;OK&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getReturn_code() &#123;</span><br><span class="line">        return return_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReturn_code(String return_code) &#123;</span><br><span class="line">        this.return_code = return_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getReturn_msg() &#123;</span><br><span class="line">        return return_msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setReturn_msg(String return_msg) &#123;</span><br><span class="line">        this.return_msg = return_msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getPayCallback方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 生成收到支付结果的确认信息</span><br><span class="line"> * @Title: getPayCallback</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @return    </span><br><span class="line"> * @return String    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public String getPayCallback()&#123;</span><br><span class="line">    PayCallback callback = new PayCallback();</span><br><span class="line">    xmlUtil.xstream().alias(&quot;xml&quot;, callback.getClass());</span><br><span class="line">    String xml = xmlUtil.xstream().toXML(callback);</span><br><span class="line"></span><br><span class="line">    return xml;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注：这里记得一定要回复确认信息，微信会可能会多次发送同样的通知给商户系统。商户系统必须能够正确处理重复的通知。</p>
<h2 id="附"><a href="#附" class="headerlink" title="附"></a>附</h2><p>HttpConnection：<a href="https://code.csdn.net/snippets/1361856" target="_blank" rel="noopener">https://code.csdn.net/snippets/1361856</a></p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.4" async></script><a data-url="http://ibenben.org/2015/11/18/49904065/" data-id="cjozgqnh4004u6gv8tt1ur5jg" class="article-share-link">分享</a><div class="tags"><a href="/tags/java/">java</a><a href="/tags/微信/">微信</a><a href="/tags/支付/">支付</a><a href="/tags/统一下单/">统一下单</a><a href="/tags/微信支付/">微信支付</a></div><div class="post-nav"><a href="/2015/11/26/50054125/" class="pre">一次MySQL的优化之旅</a><a href="/2015/11/11/49779277/" class="next">XStream双下划线问题解决与CDATA标记同时的方案</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>