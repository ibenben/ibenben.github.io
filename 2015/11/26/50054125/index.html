<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>一次MySQL的优化之旅 | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一次MySQL的优化之旅</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一次MySQL的优化之旅</h1><div class="post-meta">Nov 26, 2015<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="一、问题"><a href="#一、问题" class="headerlink" title="一、问题"></a>一、问题</h2><p>有一张数据表，表数据现在200W条左右。表结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `device_desk` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `running_number` varchar(45) DEFAULT NULL COMMENT &apos;流水号&apos;,</span><br><span class="line">  `time` timestamp NULL DEFAULT NULL COMMENT &apos;时间&apos;,</span><br><span class="line">  `temperature` double DEFAULT NULL COMMENT &apos;温度&apos;,</span><br><span class="line">  `humidity` double DEFAULT NULL COMMENT &apos;湿度&apos;,</span><br><span class="line">  `body_infrared` int(11) DEFAULT NULL COMMENT &apos;人体红外&apos;,</span><br><span class="line">  `particulate_matter` int(11) DEFAULT NULL COMMENT &apos;PM2.5&apos;,</span><br><span class="line">  `air_quality` int(11) DEFAULT NULL COMMENT &apos;空气质量&apos;,</span><br><span class="line">  `brightness` int(11) DEFAULT NULL COMMENT &apos;灯光亮度&apos;,</span><br><span class="line">  `device_id` int(11) DEFAULT NULL COMMENT &apos;设备编号&apos;,</span><br><span class="line">  `phone` varchar(45) DEFAULT NULL COMMENT &apos;手机号码&apos;,</span><br><span class="line">  `origin` varchar(100) DEFAULT NULL COMMENT &apos;原始值&apos;,</span><br><span class="line">  `color` varchar(45) DEFAULT NULL COMMENT &apos;颜色(用于自定义备注)&apos;,</span><br><span class="line">  `remark` varchar(45) DEFAULT NULL COMMENT &apos;备注&apos;</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `fk_device_idx` (`device_id`),</span><br><span class="line">  KEY `index_common_2` (`body_infrared`,`day`,`device_id`,`phone`,`time`),</span><br><span class="line">  CONSTRAINT `fk_device2` FOREIGN KEY (`device_id`) REFERENCES `device` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=2123065 DEFAULT CHARSET=utf8 COMMENT=&apos;桌子数据&apos;;</span><br></pre></td></tr></table></figure></p>
<p>业务：<br>需要找出手机号码为13800000000，绑定的设备编号为164,在2015年11月26日有人在的时间段。body_infrared字段0表示无人，1、16、17都表示有人。</p>
<p>查询语句为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select *  from device_desk t </span><br><span class="line">where t.body_infrared&gt;0</span><br><span class="line">and t.phone=&apos;13800000000&apos;</span><br><span class="line">and t.device_id=164</span><br><span class="line">and t.time like &apos;2015-11-25%&apos; </span><br><span class="line">order by t.time;</span><br></pre></td></tr></table></figure></p>
<p>得到查询结果所需耗时为83秒。<br><img src="/img/article/20151126140937909.png" alt="这里写图片描述"></p>
<p>下面我们相办法把这个查询时间尽可能缩短。</p>
<h2 id="二、优化过程"><a href="#二、优化过程" class="headerlink" title="二、优化过程"></a>二、优化过程</h2><h2 id="1、使用精确的字段代替"><a href="#1、使用精确的字段代替" class="headerlink" title="1、使用精确的字段代替*"></a>1、使用精确的字段代替*</h2><p>其实我这里需要获取的只有时间time,备注remark,和颜色color。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select  t.time,t.remark,t.color from device_desk t </span><br><span class="line">where t.body_infrared&gt;0</span><br><span class="line">and t.phone=&apos;13800000000&apos;</span><br><span class="line">and t.device_id=164</span><br><span class="line">and t.time like &apos;2015-11-25%&apos; </span><br><span class="line">order by t.time;</span><br></pre></td></tr></table></figure></p>
<p>特别是使用Hibernate作为ORM中间件的朋友,会习惯性地使用HQL获取整表的所有数据，然后部分数据竟然要比获取所有数据要快。</p>
<h2 id="2、优化时间的模糊查询"><a href="#2、优化时间的模糊查询" class="headerlink" title="2、优化时间的模糊查询"></a>2、优化时间的模糊查询</h2><p>timestamp 类型的字段可以通过类字符串比较的方式来作为模糊查询的条件。而MySQL对于like %关键字作为查询条件是全表扫描的，则没法使用索引。因为我要查询的是当天（某天）的数据，因为我为这张表增加一个day字段，用于保存每天的日期。</p>
<p>增加day字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `time_table`.`device_desk` </span><br><span class="line">ADD COLUMN `day` VARCHAR(45) NULL COMMENT &apos;日期&apos; AFTER `remark`;</span><br></pre></td></tr></table></figure></p>
<p>为原有的数据的day字段赋值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update device_desk t set t.day= DATE_FORMAT(`t`.`time`, &apos;%Y-%m-%d&apos;) where t.day is null;</span><br></pre></td></tr></table></figure></p>
<p>这个操作涉及数据比较多，执行过程会比较长。</p>
<p>更新查询语句为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select  t.time,t.remark,t.color from device_desk t </span><br><span class="line">where t.body_infrared&gt;0</span><br><span class="line">and t.phone=&apos;13800000000&apos;</span><br><span class="line">and t.device_id=164</span><br><span class="line">and t.day=&apos;2015-11-25&apos; </span><br><span class="line">order by t.time;</span><br></pre></td></tr></table></figure></p>
<h2 id="3、建立索引"><a href="#3、建立索引" class="headerlink" title="3、建立索引"></a>3、建立索引</h2><p>为数据表增加一个组合索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `time_table`.`device_desk` </span><br><span class="line">ADD INDEX `index_common_2` (`body_infrared` ASC, `day` DESC, `device_id` ASC, `phone` ASC, `time` DESC);</span><br></pre></td></tr></table></figure></p>
<p>索引建立成功后，执行查询语句的时候发生需要的时间还是很长。<br>查看一下查询语句的执行过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain select  t.time,t.remark,t.color from device_desk t </span><br><span class="line">where t.body_infrared&gt;0</span><br><span class="line">and t.phone=&apos;13800000000&apos;</span><br><span class="line">and t.device_id=164</span><br><span class="line">and t.day=&apos;2015-11-25&apos; </span><br><span class="line">order by t.time;</span><br></pre></td></tr></table></figure></p>
<p>结果：<br><img src="/img/article/20151126120148800.png" alt="这里写图片描述"></p>
<p>这里发现我们的select语句并没有使用到我们建立的索引。<br>经过一番度娘谷哥后，发现MySQL的where条件中用到大于或者小于时，也是进行全表扫描，是不会使用索引查询的。所以把这个大于查询更换掉就好。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain select t.time,t.remark,t.color  from device_desk t  where (t.body_infrared=1 or t.body_infrared=16 or t.body_infrared=17)</span><br><span class="line">and t.day= &apos;2015-11-25&apos; </span><br><span class="line">and t.device_id=164</span><br><span class="line">and t.phone=&apos;13800000000&apos;</span><br><span class="line">order by t.time;</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/article/20151126140658898.png" alt="这里写图片描述"></p>
<p>这样就使用到我们建立的索引了。</p>
<p><img src="/img/article/20151126140810116.png" alt="这里写图片描述"></p>
<p>查询效率也得到了大大的改善。</p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.4" async></script><a data-url="http://ibenben.org/2015/11/26/50054125/" data-id="cjozgqnh700516gv8c2if6i6y" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2015/12/17/50339475/" class="pre">Tomcat heap 配置案例</a><a href="/2015/11/18/49904065/" class="next">Java微信开发之公众号支付接口</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>