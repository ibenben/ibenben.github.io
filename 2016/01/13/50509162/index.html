<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java微信开发之AirKiss | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java微信开发之AirKiss</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java微信开发之AirKiss</h1><div class="post-meta">Jan 13, 2016<span> | </span><span class="category"><a href="/categories/微信开发/">微信开发</a><a href="/categories/微信开发/Java相关/">Java相关</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="1、AirKiss介绍"><a href="#1、AirKiss介绍" class="headerlink" title="1、AirKiss介绍"></a>1、AirKiss介绍</h2><p><a href="http://iot.weixin.qq.com/wiki/new/index.html?page=4-1-1" target="_blank" rel="noopener">http://iot.weixin.qq.com/wiki/new/index.html?page=4-1-1</a></p>
<h2 id="2、JSAPI"><a href="#2、JSAPI" class="headerlink" title="2、JSAPI"></a>2、JSAPI</h2><p>微信硬件JSAPI接口属于微信JS-SDK的一部分</p>
<p>微信JS-SDK是微信公众平台面向网页开发者提供的基于微信内的网页开发工具包。</p>
<p>使用微信JS-SDK，公众号开发者可借助微信高效地使用拍照、选图、语音、位置、蓝牙、WiFi等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。</p>
<p>使用微信硬件JSAPI，设备厂商可以在网页通过内javascript，对设备操作的接口。例如扫描设备，连接设备，收发数据，绑定设备，Airkiss配网等。</p>
<p><img src="/img/article/20160113104934531.png" alt="这里写图片描述"></p>
<p>HTML通过JSAPI可以和设备本地收发数据（即HTML发送给微信客户端，微信客户端发给设备），无需通过服务器中转，所以速度较快。所以实时性要求高的蓝牙设备（如遥控汽车）可采用JSAPI收发数据。</p>
<p>微信硬件JSAPI接口与使用说明（已更新）:<a href="http://iot.weixin.qq.com/wiki/new/index.html?page=4-7" target="_blank" rel="noopener">http://iot.weixin.qq.com/wiki/new/index.html?page=4-7</a></p>
<h2 id="3、业务代码"><a href="#3、业务代码" class="headerlink" title="3、业务代码"></a>3、业务代码</h2><h2 id="3-1-页面引用"><a href="#3-1-页面引用" class="headerlink" title="3.1 页面引用"></a>3.1 页面引用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=&quot;java&quot; import=&quot;java.util.*&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;%@taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot; %&gt; </span><br><span class="line">&lt;%</span><br><span class="line">String path = request.getContextPath();</span><br><span class="line">String basePath = request.getScheme()+&quot;://&quot;+request.getServerName()+&quot;:&quot;+request.getServerPort()+&quot;/&quot;+path+&quot;/&quot;;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;base href=&quot;&lt;%=basePath%&gt;&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;title&gt;LETUS&lt;/title&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;format-detection&quot; content=&quot;telephone=no&quot;&gt;</span><br><span class="line">  &lt;meta name=&quot;renderer&quot; content=&quot;webkit&quot;&gt;</span><br><span class="line">  &lt;meta http-equiv=&quot;Cache-Control&quot; content=&quot;no-siteapp&quot; /&gt;</span><br><span class="line">  &lt;link rel=&quot;stylesheet&quot; href=&quot;amazeui/assets/css/amazeui.min.css&quot;/&gt;</span><br><span class="line">  &lt;style&gt;</span><br><span class="line">* &#123; margin: 0; padding: 0; &#125;  </span><br><span class="line"> html, body &#123; height: 100%; width: 100%; &#125;  </span><br><span class="line">  &lt;/style&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;设置设备Wifi&lt;/h1&gt;</span><br><span class="line">&lt;br&gt;&lt;br&gt;</span><br><span class="line">&lt;div id=&quot;message&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;!--[if (gte IE 9)|!(IE)]&gt;&lt;!--&gt;</span><br><span class="line">&lt;script src=&quot;/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;!--&lt;![endif]--&gt;</span><br><span class="line">&lt;script src=&quot;http://res.wx.qq.com/open/js/jweixin-1.0.0.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"></span><br><span class="line">    wx.config(&#123;</span><br><span class="line">        beta : true, // 开启内测接口调用，注入wx.invoke方法</span><br><span class="line">        debug : false, // 开启调试模式</span><br><span class="line">        appId : &apos;$&#123;config.appId&#125;&apos;, // 第三方app唯一标识</span><br><span class="line">        timestamp : &apos;$&#123;config.timestamp&#125;&apos;, // 生成签名的时间戳</span><br><span class="line">        nonceStr : &apos;$&#123;config.nonce&#125;&apos;, // 生成签名的随机串</span><br><span class="line">        signature : &apos;$&#123;config.signature&#125;&apos;,// 签名</span><br><span class="line">        jsApiList : [&apos;configWXDeviceWiFi&apos;] // 需要使用的jsapi列表</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    var second = 5;</span><br><span class="line">    wx.ready(function () &#123;</span><br><span class="line">        wx.checkJsApi(&#123;</span><br><span class="line">            jsApiList: [&apos;configWXDeviceWiFi&apos;],</span><br><span class="line">            success: function(res) &#123;</span><br><span class="line">                wx.invoke(&apos;configWXDeviceWiFi&apos;, &#123;&#125;, function(res)&#123;</span><br><span class="line">                    var err_msg = res.err_msg;</span><br><span class="line">                    if(err_msg == &apos;configWXDeviceWiFi:ok&apos;) &#123;</span><br><span class="line">                        $(&apos;#message&apos;).html(&quot;配置 WIFI成功，&lt;span id=&apos;second&apos;&gt;5&lt;/span&gt;秒后跳转到首页。&quot;);</span><br><span class="line">                        setInterval(count,1000);</span><br><span class="line">                        return;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        $(&apos;#message&apos;).html(&quot;配置 WIFI失败，是否&lt;a href=\&quot;/wechat/scan/airkiss&quot; + window.location.search +  &quot;\&quot;&gt;再次扫描&lt;/a&gt;。&lt;br&gt;不配置WIFI,&lt;a href=\&quot;https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxf1867e87a4eeeb16&amp;redirect_uri=http://letux.xyz/wechat/page/main&amp;response_type=code&amp;scope=snsapi_base&amp;state=1#wechat_redirect\&quot;&gt;直接进入首页&lt;/a&gt;。&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    function count()&#123;</span><br><span class="line">        second--;</span><br><span class="line">        $(&apos;#second&apos;).html(second);</span><br><span class="line">        if(second == 0)&#123;</span><br><span class="line">            //跳转到首页</span><br><span class="line">            window.location.href=&apos;/consumer/main&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>要使用JSAPI功能，先引用JSSDK文件：<a href="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" target="_blank" rel="noopener">http://res.wx.qq.com/open/js/jweixin-1.0.0.js</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;http://res.wx.qq.com/open/js/jweixin-1.0.0.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>wx.config的方法的参数大部分由后台生成，本文中是JsAPIConfig对象。jsApiList数组中，传入需要额外使用的jsapi名称，我们用到的AirKiss功能是configWXDeviceWiFi接口。<br><img src="/img/article/20160113110652918.png" alt="这里写图片描述"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wx.config(&#123;</span><br><span class="line">    beta : true, // 开启内测接口调用，注入wx.invoke方法</span><br><span class="line">    debug : false, // 开启调试模式</span><br><span class="line">    appId : &apos;$&#123;config.appId&#125;&apos;, // 第三方app唯一标识</span><br><span class="line">    timestamp : &apos;$&#123;config.timestamp&#125;&apos;, // 生成签名的时间戳</span><br><span class="line">    nonceStr : &apos;$&#123;config.nonce&#125;&apos;, // 生成签名的随机串</span><br><span class="line">    signature : &apos;$&#123;config.signature&#125;&apos;,// 签名</span><br><span class="line">    jsApiList : [&apos;configWXDeviceWiFi&apos;] // 需要使用的jsapi列表</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>检查浏览器是否支持configWXDeviceWiFi接口，并使用此接口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wx.ready(function () &#123;</span><br><span class="line">    wx.checkJsApi(&#123;</span><br><span class="line">        jsApiList: [&apos;configWXDeviceWiFi&apos;],</span><br><span class="line">        success: function(res) &#123;</span><br><span class="line">            wx.invoke(&apos;configWXDeviceWiFi&apos;, &#123;&#125;, function(res)&#123;</span><br><span class="line">                var err_msg = res.err_msg;</span><br><span class="line">                if(err_msg == &apos;configWXDeviceWiFi:ok&apos;) &#123;</span><br><span class="line">                    //配置成功</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    //配置失败</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>3.2 JsAPIConfig实体类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">package com.benben.timetable.wechat.entity;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * JS-SDK使用的配置信息</span><br><span class="line"> * @ClassName: JsAPIConfig </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟（笨笨） </span><br><span class="line"> * @date 2015年8月17日 下午3:12:35 </span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class JsAPIConfig &#123;</span><br><span class="line">    private boolean debug;</span><br><span class="line">    private String appId;</span><br><span class="line">    private String timestamp;</span><br><span class="line">    private String nonce;</span><br><span class="line">    private String signature;</span><br><span class="line">    private String title;</span><br><span class="line">    private String link;</span><br><span class="line">    private String signType;</span><br><span class="line">    private String packageName;</span><br><span class="line"></span><br><span class="line">    public JsAPIConfig()&#123;</span><br><span class="line">        signType = &quot;MD5&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isDebug() &#123;</span><br><span class="line">        return debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setDebug(boolean debug) &#123;</span><br><span class="line">        this.debug = debug;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getAppId() &#123;</span><br><span class="line">        return appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAppId(String appId) &#123;</span><br><span class="line">        this.appId = appId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTimestamp() &#123;</span><br><span class="line">        return timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTimestamp(String timestamp) &#123;</span><br><span class="line">        this.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getNonce() &#123;</span><br><span class="line">        return nonce;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setNonce(String nonce) &#123;</span><br><span class="line">        this.nonce = nonce;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSignature() &#123;</span><br><span class="line">        return signature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSignature(String signature) &#123;</span><br><span class="line">        this.signature = signature;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getTitle() &#123;</span><br><span class="line">        return title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setTitle(String title) &#123;</span><br><span class="line">        this.title = title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getLink() &#123;</span><br><span class="line">        return link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setLink(String link) &#123;</span><br><span class="line">        this.link = link;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getSignType() &#123;</span><br><span class="line">        return signType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSignType(String signType) &#123;</span><br><span class="line">        this.signType = signType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPackageName() &#123;</span><br><span class="line">        return packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPackageName(String packageName) &#123;</span><br><span class="line">        this.packageName = packageName;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里默认使用MD5加密方式。</p>
<h2 id="3-3-获取api-ticket"><a href="#3-3-获取api-ticket" class="headerlink" title="3.3 获取api_ticket"></a>3.3 获取api_ticket</h2><p>api_ticket会在生成JsAPIConfig对象signature（签名）属性时用到。</p>
<p>api_ticket获取地址：<a href="https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&amp;access_token=ACCESS_TOKEN" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&amp;access_token=ACCESS_TOKEN</a></p>
<p>通过http get请求方式获取：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取jsTicket</span><br><span class="line"> * @Title: getJsTicketFromWechat </span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @return</span><br><span class="line"> * @param @throws Exception   </span><br><span class="line"> * @return String   </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public  String getJsTicketFromWechat() throws Exception&#123;  </span><br><span class="line">    String token = getTokenFromCache();</span><br><span class="line">    String responeText = httpConnection.get(ticketUrl+token);</span><br><span class="line">    JSONObject obj = JSONObject.fromObject(responeText);</span><br><span class="line">    String jsTicket = obj.getString(&quot;ticket&quot;);</span><br><span class="line">    SystemCache.getWechatJsTicketCache().addJsTicket(jsTicket);</span><br><span class="line"></span><br><span class="line">    return jsTicket;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回JSON格式数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">    &quot;errcode&quot;:0,</span><br><span class="line">    &quot;errmsg&quot;:&quot;ok&quot;,</span><br><span class="line">    &quot;ticket&quot;:&quot;bxLdikRXVbTPdHSM05e5u5sUoXNKdvsdshFKA&quot;,</span><br><span class="line">    &quot;expires_in&quot;:7200</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意事项（很重要）：</p>
<p>1.用于卡券接口签名的api_ticket与我们这里通过config接口注入权限验证配置使用的jsapi_ticket不同。<br>卡券的ticket获取地址为：<a href="https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=wx_card" target="_blank" rel="noopener">https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&amp;type=wx_card</a></p>
<p>2.由于获取api_ticket 的api 调用次数非常有限，频繁刷新api_ticket 会导致api调用受限，影响自身业务，开发者需在自己的服务存储与更新api_ticket。api_ticket 的有效期为7200 秒。</p>
<h2 id="3-4-生成-JsAPIConfig"><a href="#3-4-生成-JsAPIConfig" class="headerlink" title="3.4 生成 JsAPIConfig"></a>3.4 生成 JsAPIConfig</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 生成JsAPIConfig</span><br><span class="line"> * @Title: createConfig</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param link 使用AirKiss的链接地址</span><br><span class="line"> * @param @return</span><br><span class="line"> * @param @throws Exception    </span><br><span class="line"> * @return JsAPIConfig    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public JsAPIConfig createConfig(String link) throws Exception &#123;</span><br><span class="line">    JsAPIConfig config = new JsAPIConfig();</span><br><span class="line">    config.setLink(link);</span><br><span class="line">    String nonce = UUID.randomUUID().toString();</span><br><span class="line">    String timestamp = Long.toString(System.currentTimeMillis() / 1000);</span><br><span class="line">    String src = &quot;jsapi_ticket=&quot; + getJsTicketFromCache() + &quot;&amp;noncestr=&quot;</span><br><span class="line">            + nonce + &quot;&amp;timestamp=&quot; + timestamp + &quot;&amp;url=&quot;</span><br><span class="line">            + config.getLink();</span><br><span class="line">    String signature = SHAEncryptor.sha1(src);</span><br><span class="line"></span><br><span class="line">    config.setAppId(appId);</span><br><span class="line">    config.setDebug(true);</span><br><span class="line">    config.setNonce(nonce);</span><br><span class="line">    config.setTimestamp(timestamp);</span><br><span class="line">    config.setSignature(signature);</span><br><span class="line"></span><br><span class="line">    return config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的getJsTicketFromCache()是从缓存中获取ticket了。有关缓存相关的技术，请自个度娘。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 从缓存中获取JsTicket</span><br><span class="line"> * @Title: getJsTicketFromCache</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @return</span><br><span class="line"> * @param @throws Exception    </span><br><span class="line"> * @return String    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public String getJsTicketFromCache() throws Exception&#123;  </span><br><span class="line">    String ticket =  SystemCache.getWechatJsTicketCache().getJsTicket();</span><br><span class="line"></span><br><span class="line">    if(ticket == null)&#123;</span><br><span class="line">        ticket = getJsTicketFromWechat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return ticket;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们要生成JsAPIConfig对象，需要引入使用AirKiss的页面。如我们这里的页面地址是<a href="http://letus.xyz/wechat/scan/airkiss。" target="_blank" rel="noopener">http://letus.xyz/wechat/scan/airkiss。</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JsAPIConfig config = createConfig(&quot;http://letus.xyz/wechat/scan/airkiss&quot;);</span><br></pre></td></tr></table></figure></p>
<h2 id="4、AirKiss页面"><a href="#4、AirKiss页面" class="headerlink" title="4、AirKiss页面"></a>4、AirKiss页面</h2><p><img src="/img/article/20160113113242850.png" alt="这里写图片描述"></p>
<p>当配置属性调用成功后，会来到AirKiss页面。输入移动设备所在网络的WiFi密码并确定，微信会通过AirKiss技术，把周围的硬件设备配置到同一网络中。</p>
<p>配置成功会返回configWXDeviceWiFi:ok信息。在配置成功后，我们再做相应的页面跳转逻辑即可。</p>
<h2 id="附"><a href="#附" class="headerlink" title="附"></a>附</h2><p>HttpConnection：<a href="https://code.csdn.net/snippets/1361856" target="_blank" rel="noopener">https://code.csdn.net/snippets/1361856</a></p>
<p>SHAEncryptor ：<a href="https://code.csdn.net/snippets/1555369" target="_blank" rel="noopener">https://code.csdn.net/snippets/1555369</a></p>
</div><div class="tags"><a href="/tags/java/">java</a><a href="/tags/微信/">微信</a><a href="/tags/AirKiss/">AirKiss</a><a href="/tags/JSAPI/">JSAPI</a><a href="/tags/微信硬件/">微信硬件</a></div><div class="post-nav"><a href="/2016/01/20/50546524/" class="pre">eclipse上搭建maven多模块Java Web项目</a><a href="/2016/01/13/50266391/" class="next">Java微信开发之现金红包接口</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>