<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>我要造轮子之基于JDK的AOP实现 | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">我要造轮子之基于JDK的AOP实现</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">我要造轮子之基于JDK的AOP实现</h1><div class="post-meta">Mar 10, 2016<span> | </span><span class="category"><a href="/categories/我要造轮子/">我要造轮子</a><a href="/categories/我要造轮子/Java相关/">Java相关</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h2><p>Aspect Oriented Programing，面向切面编程。</p>
<p>利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。</p>
<p>AOP主要用于日志记录，性能统计，安全控制（权限控制），事务处理，异常处理等。将日志记录，性能统计，安全控制，事务处理，异常处理等代码从业务逻辑代码中划分出来，通过对这些行为的分离，我们希望可以将它们独立到非指导业务逻辑的方法中，进而改变这些行为的时候不影响业务逻辑的代码。</p>
<p>像Spring AOP一样，我们要的AOP也需要依赖于IoC容器。</p>
<p>我们的IoC容器实现：<a href="http://blog.csdn.net/jrainbow/article/details/50680914" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/50680914</a></p>
<p>本文就是通过JDK提供的反射机制来实现类似基于@AspectJ的Spring AOP的使用。</p>
<h2 id="2-AOP的实现需求"><a href="#2-AOP的实现需求" class="headerlink" title="2 AOP的实现需求"></a>2 AOP的实现需求</h2><p>基于@Aspect的Spring AOP使用：<a href="http://blog.csdn.net/jrainbow/article/details/9268637" target="_blank" rel="noopener">http://blog.csdn.net/jrainbow/article/details/9268637</a></p>
<p>我们通过一个基于@Aspect的Spring AOP的使用模板来看看我们需要实现哪些功能。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * 通过@Aspect把这个类标识管理一些切面</span><br><span class="line"> */</span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class FirstAspect &#123;  </span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * 定义切点及增强类型</span><br><span class="line">     */</span><br><span class="line">    @Before(&quot;execution(* save(..))&quot;)</span><br><span class="line">    public void before()&#123;</span><br><span class="line">        System.out.println(&quot;我是前置增强...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从Spirng AOP的@Aspect使用代码可以看到，我们如果想实现类似这样的功能，需要对最基本的几个声明进行解析：切面、切点、增强类型。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Before(value= &quot;切入点表达式或命名切入点&quot;,argNames = &quot;指定命名切入点方法参数列表参数名字，可以有多个用“,”分隔&quot;)</span><br></pre></td></tr></table></figure></p>
<p>切面与增强类型都是annotation。<br>而切点，从@Before注解看来，是一个表达式加上方法参数列表参数名字的形式。</p>
<p>Spring AOP中的切点表达式是结合正则表达式及它本身自有的一些规则产生的，我们这里不要太复杂，也不需要方法参数列表参数名字这个属性，直接是先考虑使用正则表达式来表示。</p>
<p>确定了以上的内容后，下面我们以前置增强为例开始代码实现。</p>
<h2 id="3-实现过程"><a href="#3-实现过程" class="headerlink" title="3 实现过程"></a>3 实现过程</h2><h2 id="3-1-切面及增强类型注解"><a href="#3-1-切面及增强类型注解" class="headerlink" title="3.1 切面及增强类型注解"></a>3.1 切面及增强类型注解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.aop.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 切面</span><br><span class="line"> * @ClassName: Aspect</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2016年3月7日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface Aspect &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.aop.annotation;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.ElementType;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.RetentionPolicy;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 前置增强注解</span><br><span class="line"> * @ClassName: Before</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2016年3月7日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface Before &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 切点表达式</span><br><span class="line">     * </span><br><span class="line">     * @Title: value</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @return    </span><br><span class="line">     * @return String    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    String value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-扫描-Aspect的托管"><a href="#3-2-扫描-Aspect的托管" class="headerlink" title="3.2 扫描@Aspect的托管"></a>3.2 扫描@Aspect的托管</h2><p>因为我们的AOP也需要依赖于IoC容器，我们这里也使用ClassFactory类在描述basePackage包下的类时，把@Aspect描述的类找出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 解析路径，并获取所要的类</span><br><span class="line"> * @Title: parse</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @return void    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">public void parse()&#123;</span><br><span class="line">    for (String packagePath : packages) &#123;</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; classes = ClassLoader.getClassSet(packagePath);</span><br><span class="line">        for(Class&lt;?&gt; clazz : classes)&#123;</span><br><span class="line">            if(clazz.isAnnotationPresent(Component.class))&#123;</span><br><span class="line">                //普通类托管</span><br><span class="line">                ...</span><br><span class="line">            &#125;else if(clazz.isAnnotationPresent(Aspect.class))&#123;</span><br><span class="line">                //切面类托管</span><br><span class="line">                aspectClasses.put(clazz.getSimpleName(), clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整的ClassFactory类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.util;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import xyz.letus.framework.aop.annotation.Aspect;</span><br><span class="line">import xyz.letus.framework.ioc.annotation.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 类操作助手</span><br><span class="line"> * @ClassName: ClassHelper</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2015年9月19日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class ClassFactory &#123;</span><br><span class="line">    private Map&lt;String, Class&lt;?&gt;&gt; componentClasses;</span><br><span class="line">    private Map&lt;String, Class&lt;?&gt;&gt; aspectClasses;</span><br><span class="line">    private List&lt;String&gt; packages;</span><br><span class="line"></span><br><span class="line">    public ClassFactory(List&lt;String&gt; packages)&#123;</span><br><span class="line">        this.packages = packages;</span><br><span class="line">        componentClasses = new HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">        aspectClasses = new HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">        this.parse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 解析路径，并获取所要的类</span><br><span class="line">     * @Title: parse</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @return void    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void parse()&#123;</span><br><span class="line">        for (String packagePath : packages) &#123;</span><br><span class="line">            Set&lt;Class&lt;?&gt;&gt; classes = ClassLoader.getClassSet(packagePath);</span><br><span class="line">            for(Class&lt;?&gt; clazz : classes)&#123;</span><br><span class="line">                if(clazz.isAnnotationPresent(Component.class))&#123;</span><br><span class="line">                    //普通类托管</span><br><span class="line">                    Component component = clazz.getAnnotation(Component.class);</span><br><span class="line">                    String name = clazz.getSimpleName();</span><br><span class="line">                    String value = component.value();</span><br><span class="line">                    if(value.length() &gt; 0)&#123;</span><br><span class="line">                        name = value;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    componentClasses.put(name, clazz);</span><br><span class="line">                &#125;else if(clazz.isAnnotationPresent(Aspect.class))&#123;</span><br><span class="line">                    //切面类托管</span><br><span class="line">                    aspectClasses.put(clazz.getSimpleName(), clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Class&lt;?&gt;&gt; getComponentClasses() &#123;</span><br><span class="line">        return componentClasses;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Class&lt;?&gt;&gt; getAspectClasses() &#123;</span><br><span class="line">        return aspectClasses;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注：Spring可能为了不修改原有的IoC实现，托管的注解和切面的注解是分开的，而我们这里是放一起的。<br>Spring要使用切面的时候，需要使用两个注解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class FirstAspect &#123;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-4-代理工具类"><a href="#3-4-代理工具类" class="headerlink" title="3.4 代理工具类"></a>3.4 代理工具类</h2><p>我们这里通过JDK提供的java.lang.reflect.Proxy来创建代理对象。不过Proxy比较局限的地方在于，代理对象的目标对象必须是基于接口的实现。当然这也是本文中基于JDK的AOP实现的不足之一。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.aop;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 代理管理器</span><br><span class="line"> * @ClassName: ProxyManager</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2016年3月7日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class ProxyManager &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 创建一个前置增强的代理对象</span><br><span class="line">     * @Title: createBeforeProxy</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param aspect 切面对象</span><br><span class="line">     * @param @param target 目标对象</span><br><span class="line">     * @param @param matchMethods 匹配的方法名</span><br><span class="line">     * @param @param before 前置增强方法</span><br><span class="line">     * @param @return    </span><br><span class="line">     * @return T    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public static &lt;T&gt; T createBeforeProxy(final Object aspect,final Object target,final List&lt;String&gt; matchMethods,final Method before)&#123;</span><br><span class="line">        return (T) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), new InvocationHandler() &#123;</span><br><span class="line"></span><br><span class="line">            public Object invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">                    throws Throwable &#123;</span><br><span class="line">                /**</span><br><span class="line">                 * 增加前置增强</span><br><span class="line">                 */</span><br><span class="line">                if(matchMethods.contains(method.getName()))&#123;</span><br><span class="line">                    before.invoke(aspect, args);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object result = method.invoke(target, args);</span><br><span class="line">                return result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-4-切面管理"><a href="#3-4-切面管理" class="headerlink" title="3.4 切面管理"></a>3.4 切面管理</h2><p>在获取到所有的切面类后，我们对切面类里的增强方法进行分析处理。我们判断所有托管的普通类对象中是否有符合切点表达式的方法。并通过ProxyManager来为有符合切点方法的类对象织入增强，创建代理对象，并替换掉原有的对象，并由IoC容器管理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 前置增强处理</span><br><span class="line"> * @Title: beforeHandle</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param aspect 切面对象</span><br><span class="line"> * @param @param beforeMethod  增强方法</span><br><span class="line"> * @return void    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">private void beforeHandle(Object aspect,Method beforeMethod)&#123;</span><br><span class="line">    Before before = beforeMethod.getAnnotation(Before.class);</span><br><span class="line">    String execution = before.value();</span><br><span class="line">    for (Entry&lt;String,Object&gt; entry : beanMap.entrySet()) &#123;</span><br><span class="line">        String name = entry.getKey();</span><br><span class="line">        Object target = entry.getValue();</span><br><span class="line">        List&lt;String&gt; list = getMatchMethod(execution, target);</span><br><span class="line">        if(list.size() &gt; 0)&#123;</span><br><span class="line">            Object obj = ProxyManager.createBeforeProxy(aspect, target, list, beforeMethod);</span><br><span class="line">            beanMap.put(name, obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>符合切点表达式的解析比较简单，就是完整类名加方法名的正则匹配。<br>这里要注意的是，我们需要对目标对象的接口方法进行判断，而不是目标对象的方法进行匹配。因为如果一个对象需要织入多个增强，我们需要进行多次代理对象的替换，而代理对象的路径并不是原有路径，不能匹配之前定义的正则表达式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 获取匹配的方法名</span><br><span class="line"> * </span><br><span class="line"> * 现只做完整类名加方法名的解析</span><br><span class="line"> * @Title: getMatchMethod</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @param @param before</span><br><span class="line"> * @param @param target</span><br><span class="line"> * @param @return    </span><br><span class="line"> * @return boolean    </span><br><span class="line"> * @throws</span><br><span class="line"> */</span><br><span class="line">private List&lt;String&gt; getMatchMethod(String execution,Object target)&#123;</span><br><span class="line">    List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span><br><span class="line">    Class&lt;?&gt;[] classes = target.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">    for(Class&lt;?&gt; clazz : classes)&#123;</span><br><span class="line">        Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">        Pattern pattern = Pattern.compile(execution);</span><br><span class="line"></span><br><span class="line">        for(Method method : methods)&#123;</span><br><span class="line">            StringBuffer methodName = new StringBuffer(clazz.getName());</span><br><span class="line">            methodName.append(&quot;.&quot;).append(method.getName());</span><br><span class="line">            if(pattern.matcher(methodName).matches())&#123;</span><br><span class="line">                list.add(method.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整的切面管理类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.aop;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Map.Entry;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">import xyz.letus.framework.aop.annotation.Before;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 切面管理</span><br><span class="line"> * @ClassName: AspectManager</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2016年3月7日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class AspectManager &#123;</span><br><span class="line">    private Map&lt;String, Object&gt; beanMap;</span><br><span class="line"></span><br><span class="line">    public AspectManager(Map&lt;String, Object&gt; beanMap)&#123;</span><br><span class="line">        this.beanMap = beanMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 对所有切面进行解析</span><br><span class="line">     * @Title: parse</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param aspectClasses    </span><br><span class="line">     * @return void    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public void parse(Map&lt;String, Class&lt;?&gt;&gt; aspectClasses) &#123;</span><br><span class="line">        for (Entry&lt;String, Class&lt;?&gt;&gt; entry : aspectClasses.entrySet()) &#123;</span><br><span class="line">            parse(entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 解析一个切面</span><br><span class="line">     * @Title: parse</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param clazz    </span><br><span class="line">     * @return void    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    private void parse(Class&lt;?&gt; clazz) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Method[] methods = clazz.getMethods();</span><br><span class="line">            Object aspect = clazz.newInstance();</span><br><span class="line">            for(Method method : methods)&#123;</span><br><span class="line">                if(method.isAnnotationPresent(Before.class))&#123;</span><br><span class="line">                    beforeHandle(aspect,method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取匹配的方法名</span><br><span class="line">     * </span><br><span class="line">     * 现只做完整类名加方法名的解析</span><br><span class="line">     * @Title: getMatchMethod</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param before</span><br><span class="line">     * @param @param target</span><br><span class="line">     * @param @return    </span><br><span class="line">     * @return boolean    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    private List&lt;String&gt; getMatchMethod(String execution,Object target)&#123;</span><br><span class="line">        List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span><br><span class="line">        Class&lt;?&gt;[] classes = target.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">        for(Class&lt;?&gt; clazz : classes)&#123;</span><br><span class="line">            Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">            Pattern pattern = Pattern.compile(execution);</span><br><span class="line"></span><br><span class="line">            for(Method method : methods)&#123;</span><br><span class="line">                StringBuffer methodName = new StringBuffer(clazz.getName());</span><br><span class="line">                methodName.append(&quot;.&quot;).append(method.getName());</span><br><span class="line">                if(pattern.matcher(methodName).matches())&#123;</span><br><span class="line">                    list.add(method.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 前置增强处理</span><br><span class="line">     * @Title: beforeHandle</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param aspect 切面对象</span><br><span class="line">     * @param @param beforeMethod  增强方法</span><br><span class="line">     * @return void    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    private void beforeHandle(Object aspect,Method beforeMethod)&#123;</span><br><span class="line">        Before before = beforeMethod.getAnnotation(Before.class);</span><br><span class="line">        String execution = before.value();</span><br><span class="line">        for (Entry&lt;String,Object&gt; entry : beanMap.entrySet()) &#123;</span><br><span class="line">            String name = entry.getKey();</span><br><span class="line">            Object target = entry.getValue();</span><br><span class="line">            List&lt;String&gt; list = getMatchMethod(execution, target);</span><br><span class="line">            if(list.size() &gt; 0)&#123;</span><br><span class="line">                Object obj = ProxyManager.createBeforeProxy(aspect, target, list, beforeMethod);</span><br><span class="line">                beanMap.put(name, obj);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Map&lt;String, Object&gt; getBeanMap() &#123;</span><br><span class="line">        return beanMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="3-5-替换BEAN-MAP"><a href="#3-5-替换BEAN-MAP" class="headerlink" title="3.5 替换BEAN_MAP"></a>3.5 替换BEAN_MAP</h2><p>把拥有代理对象的map替换到BeanFactory中去。<br>完整的BeanFactory：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.framework.ioc;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.Map.Entry;</span><br><span class="line"></span><br><span class="line">import xyz.letus.framework.aop.AspectManager;</span><br><span class="line">import xyz.letus.framework.util.ClassFactory;</span><br><span class="line">import xyz.letus.framework.util.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Bean助手类</span><br><span class="line"> * @ClassName: BeanHelper</span><br><span class="line"> * @Description: TODO</span><br><span class="line"> * @author 潘广伟(笨笨)</span><br><span class="line"> * @date 2015年9月19日</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public class BeanFactory &#123;</span><br><span class="line">    private static Map&lt;String, Object&gt; BEAN_MAP = new HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 创建所有托管的实例</span><br><span class="line">     * @Title: createInstance</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param packages    </span><br><span class="line">     * @return void    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    public static void createInstance(List&lt;String&gt; packages)&#123;</span><br><span class="line">        ClassFactory classFactory = new ClassFactory(packages);</span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; componentClasses = classFactory.getComponentClasses();</span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; aspectClasses = classFactory.getAspectClasses();</span><br><span class="line"></span><br><span class="line">        //对普通的托管类进行处理</span><br><span class="line">        for (Entry&lt;String, Class&lt;?&gt;&gt; entry : componentClasses.entrySet()) &#123;</span><br><span class="line">            Object obj = ReflectionFactory.newInstance(entry.getValue());</span><br><span class="line"></span><br><span class="line">            BEAN_MAP.put(entry.getKey(), obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //依赖注入</span><br><span class="line">        IocHelper.inject(BEAN_MAP);</span><br><span class="line"></span><br><span class="line">        //切面处理</span><br><span class="line">        AspectManager aspectManager = new AspectManager(BEAN_MAP);</span><br><span class="line">        aspectManager.parse(aspectClasses);</span><br><span class="line">        BEAN_MAP = aspectManager.getBeanMap();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取Bean实例</span><br><span class="line">     * @Title: getBean</span><br><span class="line">     * @Description: TODO</span><br><span class="line">     * @param @param name</span><br><span class="line">     * @param @return    </span><br><span class="line">     * @return T    </span><br><span class="line">     * @throws</span><br><span class="line">     */</span><br><span class="line">    @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">    public static &lt;T&gt; T getBean(String name)&#123;</span><br><span class="line">        if(!BEAN_MAP.containsKey(name))&#123;</span><br><span class="line">            throw new RuntimeException(&quot;can not get bean by className:&quot;+name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return (T) BEAN_MAP.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-框架使用"><a href="#4-框架使用" class="headerlink" title="4 框架使用"></a>4 框架使用</h2><p>与IoC容器框架的使用类似。<br>我们对之前的Service类，让它实现一个接口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.demo.service;</span><br><span class="line"></span><br><span class="line">public interface IService &#123;</span><br><span class="line">    public void say();</span><br><span class="line">    public void play();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.demo.service;</span><br><span class="line"></span><br><span class="line">import xyz.letus.demo.dao.Dao;</span><br><span class="line">import xyz.letus.framework.ioc.annotation.Component;</span><br><span class="line">import xyz.letus.framework.ioc.annotation.Inject;</span><br><span class="line"></span><br><span class="line">@Component(&quot;service&quot;)</span><br><span class="line">public class Service implements IService&#123;</span><br><span class="line">    @Inject(&quot;a&quot;)</span><br><span class="line">    private Dao dao;</span><br><span class="line"></span><br><span class="line">    public void say()&#123;</span><br><span class="line">        dao.say();</span><br><span class="line">        System.out.println(&quot;Service say something.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void play() &#123;</span><br><span class="line">        System.out.println(&quot;Service playing.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过框架注解定义一个切面</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package xyz.letus.demo.aspect;</span><br><span class="line"></span><br><span class="line">import xyz.letus.framework.aop.annotation.Aspect;</span><br><span class="line">import xyz.letus.framework.aop.annotation.Before;</span><br><span class="line"></span><br><span class="line">@Aspect</span><br><span class="line">public class BeforeAspect &#123;</span><br><span class="line">    @Before(&quot;xyz.letus.demo.service.*.*&quot;)</span><br><span class="line">    public void beforeA()&#123;</span><br><span class="line">        System.out.println(&quot;beforeA&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Before(&quot;xyz.letus.demo.service.*.say&quot;)</span><br><span class="line">    public void beforeB()&#123;</span><br><span class="line">        System.out.println(&quot;beforeB&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>切面中定义了两个前置增强，一个增强是针对xyz.letus.demo.service包下的所有接口方法，另一个是针对xyz.letus.demo.service包下的所有接口的say方法。</p>
<ul>
<li>资源文件context.properties没变化，依然只需配置需扫描的主包。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanPackage=xyz.letus.demo</span><br></pre></td></tr></table></figure>
<ul>
<li>启动IoC容器，并获取service实例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context = ApplicationContext.getContext(&quot;context.properties&quot;);</span><br><span class="line">IService service = context.getBean(&quot;service&quot;);</span><br><span class="line">service.say();</span><br><span class="line">service.play();</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">beforeA</span><br><span class="line">beforeB</span><br><span class="line">Dao say something.</span><br><span class="line">Service say something.</span><br><span class="line">====================</span><br><span class="line">beforeA</span><br><span class="line">Service playing.</span><br></pre></td></tr></table></figure>
<p>可以看到say方法成功织入了两个前置增强，而play方法也成功织入了一个增强。</p>
<h2 id="5-不足"><a href="#5-不足" class="headerlink" title="5 不足"></a>5 不足</h2><ol>
<li>通过JDK提供的java.lang.reflect.Proxy来创建代理对象的目标对象必须是基于接口的实现。</li>
<li>如果有多个增强针对同一个类的话，需要多次创建代理对象。</li>
<li>由于为了快速开发的关系，之前的IoC容器和本文的AOP框架没有解耦。</li>
</ol>
<h2 id="6-源码下载"><a href="#6-源码下载" class="headerlink" title="6 源码下载"></a>6 源码下载</h2><p><a href="https://github.com/benben-ren/wheel/tree/36e8a8d84896947349291675c9db37ce8701f590" target="_blank" rel="noopener">https://github.com/benben-ren/wheel/tree/36e8a8d84896947349291675c9db37ce8701f590</a></p>
<p>注：源码中只有IoC与AOP构架源码，不包含使用源码。</p>
</div><div class="tags"><a href="/tags/jdk/">jdk</a><a href="/tags/AOP/">AOP</a><a href="/tags/Proxy/">Proxy</a><a href="/tags/轮子/">轮子</a><a href="/tags/反射/">反射</a></div><div class="post-nav"><a href="/2016/03/15/50886981/" class="pre">Java Collection笔记之ArrayList</a><a href="/2016/02/18/50680914/" class="next">我要造轮子之IoC和依赖注入</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>