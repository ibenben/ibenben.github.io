<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>javaer to go之简单的ORM封装 | 笨笨个人笔记</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.0.4"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body style="background:#fbfbfb;"><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">javaer to go之简单的ORM封装</h1><a id="logo" href="/.">笨笨个人笔记</a><p class="description">ibenben.org</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">javaer to go之简单的ORM封装</h1><div class="post-meta">Apr 11, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>身为一个做企业级开发的javaer，习惯使用hibernate、ibatis等ORM框架来操作数据库。虽然也发现golang也有ORM框架，像beego ORM等。</p>
<p>为了熟悉golang的一些特性，我还是觉得自己封装一个ORM。</p>
<h2 id="1、struct与interface简单说明"><a href="#1、struct与interface简单说明" class="headerlink" title="1、struct与interface简单说明"></a>1、struct与interface简单说明</h2><p>golang是一门面向过程的语言，所以它本身是没有像java那样的类与对象的概念。但golang中提供了struct与interface。甚至通过struct与interface结合，可以模拟类与对象的各种方式。</p>
<p>什么是interface，golang的interface与java的interface是不是一回事呢？</p>
<p>简单的说，interface是一组method的组合，我们通过interface来定义对象的一组行为。</p>
<p>一个类型如果拥有一接口的所有方法，那这个类型实现了这一接口。而不是像java那样使用implements关键字。</p>
<p>所有类型都实现了一个空接口，也就是我们可以通过空接口类型传入（返回）所有类型参数。类似java的Object是所有类的父类一样，空接口interface{}是golang中所有类型的父接口。</p>
<ul>
<li>简单的struct</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type Object struct &#123;</span><br><span class="line">    Id              int       </span><br><span class="line">    name          string</span><br><span class="line">    Age   int  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>简单的interface</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type IObject interface &#123;</span><br><span class="line">    SetName(name string)</span><br><span class="line">    GetName() string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>interface的实现</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func (this *Object) SetName(name string)() &#123;</span><br><span class="line">    this.name = name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (this *Object) GetName() string &#123;</span><br><span class="line">    return this.name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、反射机制简单说明"><a href="#2、反射机制简单说明" class="headerlink" title="2、反射机制简单说明"></a>2、反射机制简单说明</h2><p>与java一样，golang也提供了反射工具。</p>
<p>golang的reflect包主要有两个数据类型Type和Value。Type就是定义的类型的一个数据类型，Value是值的类型。<br>golang的反射就是把类型变量(对象)，转成Type或Value，然后在运行时，对其操作的过程。</p>
<p>reflect的TypeOf与ValueOf可以把任意类型对象转成转成Type或Value。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// TypeOf returns the reflection Type that represents the dynamic type of i.</span><br><span class="line">// If i is a nil interface value, TypeOf returns nil.</span><br><span class="line">func TypeOf(i interface&#123;&#125;) Type &#123;</span><br><span class="line">    eface := *(*emptyInterface)(unsafe.Pointer(&amp;i))</span><br><span class="line">    return toType(eface.typ)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// ValueOf returns a new Value initialized to the concrete value</span><br><span class="line">// stored in the interface i.  ValueOf(nil) returns the zero Value.</span><br><span class="line">func ValueOf(i interface&#123;&#125;) Value &#123;</span><br><span class="line">    if i == nil &#123;</span><br><span class="line">        return Value&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // TODO: Maybe allow contents of a Value to live on the stack.</span><br><span class="line">    // For now we make the contents always escape to the heap.  It</span><br><span class="line">    // makes life easier in a few places (see chanrecv/mapassign</span><br><span class="line">    // comment below).</span><br><span class="line">    escapes(i)</span><br><span class="line"></span><br><span class="line">    return unpackEface(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3、struct实现Entity与Annotation"><a href="#3、struct实现Entity与Annotation" class="headerlink" title="3、struct实现Entity与Annotation"></a>3、struct实现Entity与Annotation</h2><p>Java的ORM实现，如Hibernate，是通过xml配置文件或者annotation来把对象与表关联起来的。</p>
<p>当然，golang也可以使用xml的方式来做关联。但xml配置文件使用起来比较麻烦，但golang却没有annotation这样的东西。</p>
<p>还好golang的struct中，除了变量名和类型之外，还可以选择性的增加一些tag：tag可以在类型的后面，用双引号(double quote)或重音(backquote/grave accent)表示的字符串。这些符号能被用来做文档或重要的标签。</p>
<p>tag里面的内容在正常编程中没有作用。只有在使用反射的时候才有作用。我们可以在运行时，对tag进行解析，以达到类似注解说明的效果。</p>
<p>我们的Entity：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Entity struct &#123;</span><br><span class="line">    Id   int       `table:&quot;table_name&quot; column:&quot;id&quot;`</span><br><span class="line">    Time time.Time `column:&quot;time&quot;`</span><br><span class="line">    Name string    `column:&quot;day&quot;`</span><br><span class="line">    Age  string    `column:&quot;age&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的struct中，类型后面的就是tag。与Hibernate一样，我们的ORM希望我们的表都有主键。这里写的ORM，只支持简单的主键。</p>
<ul>
<li>tag中的column对应的是表的列</li>
<li>tag中的table描述用于主键字段，它即代表着主键，也说明了实体映射的表。</li>
</ul>
<p>有了tag的描述后，我们就可以把ORM的O与R mapping起来了。</p>
<h2 id="4、单例模式的数据库连接"><a href="#4、单例模式的数据库连接" class="headerlink" title="4、单例模式的数据库连接"></a>4、单例模式的数据库连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var sqlDB *sql.DB</span><br><span class="line"></span><br><span class="line">func Open() *sql.DB &#123;</span><br><span class="line">    if sqlDB == nil &#123;</span><br><span class="line">        db, err := sql.Open(&quot;mysql&quot;, &quot;用户名:密码@/数据库名?charset=utf8&quot;)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            fmt.Println(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">        sqlDB = db</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sqlDB</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5、数据库操作基类（BaseDao）的定义"><a href="#5、数据库操作基类（BaseDao）的定义" class="headerlink" title="5、数据库操作基类（BaseDao）的定义"></a>5、数据库操作基类（BaseDao）的定义</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type IBaseDao interface &#123;</span><br><span class="line">    Init()</span><br><span class="line">    Save(data interface&#123;&#125;) error</span><br><span class="line">    Update(data interface&#123;&#125;) error</span><br><span class="line">    SaveOrUpdate(data interface&#123;&#125;) error</span><br><span class="line">    SaveAll(datas list.List) error</span><br><span class="line">    Delete(data interface&#123;&#125;) error</span><br><span class="line">    Find(sql string) (*list.List, error)</span><br><span class="line">    FindOne(sql string) (interface&#123;&#125;, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type BaseDao struct &#123;</span><br><span class="line">    EntityType reflect.Type</span><br><span class="line">    sqlDB      *sql.DB</span><br><span class="line">    tableName     string            //表名</span><br><span class="line">    pk            string            //主键</span><br><span class="line">    columnToField map[string]string //字段名:属性名</span><br><span class="line">    fieldToColumn map[string]string //属性名:字段名</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IBaseDao接口中，Init是接口实现时的初始化。除了Init外都是数据库的DML操作，就是所谓的增删改查。</p>
<p>BaseDao的EntityType属性类似Java中的泛型对象（如下面的clazz），用于获取操作实体对象的属性与标签。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class BaseDao&lt;T,PK extends Serializable&gt; extends HibernateDaoSupport implements IBaseDao&lt;T,PK&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private Class&lt;T&gt; clazz;</span><br><span class="line"></span><br><span class="line">    public BaseDao() &#123;</span><br><span class="line">        ParameterizedType type = (ParameterizedType) this.getClass().getGenericSuperclass();</span><br><span class="line">        clazz = (Class&lt;T&gt;) type.getActualTypeArguments()[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="6、BaseDao的初始化过程"><a href="#6、BaseDao的初始化过程" class="headerlink" title="6、BaseDao的初始化过程"></a>6、BaseDao的初始化过程</h2><p>BaseDao的初始化过程，就是通过解析struct的tag，来把struct的变量与表的列一一对应起来的过程。</p>
<ol>
<li>我们可以在后面的使用中，通过columnToField键值对，获取列对应的变量名</li>
<li>通过fieldToColumn键值对，获取变量名对应的列</li>
<li>通过pk变量获取主键的列</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//初始化</span><br><span class="line">func (this *BaseDao) Init() &#123;</span><br><span class="line">    this.columnToField = make(map[string]string)</span><br><span class="line">    this.fieldToColumn = make(map[string]string)</span><br><span class="line"></span><br><span class="line">    types := this.EntityType</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; types.NumField(); i++ &#123;</span><br><span class="line">        typ := types.Field(i)</span><br><span class="line">        tag := typ.Tag</span><br><span class="line"></span><br><span class="line">        if len(tag) &gt; 0 &#123;</span><br><span class="line">            column := tag.Get(&quot;column&quot;)</span><br><span class="line">            name := typ.Name</span><br><span class="line">            this.columnToField[column] = name</span><br><span class="line">            this.fieldToColumn[name] = column</span><br><span class="line"></span><br><span class="line">            if len(tag.Get(&quot;table&quot;)) &gt; 0 &#123;</span><br><span class="line">                this.tableName = tag.Get(&quot;table&quot;)</span><br><span class="line">                this.pk = column</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、增加"><a href="#7、增加" class="headerlink" title="7、增加"></a>7、增加</h2><ul>
<li>预处理的insert语句封装以及占位符代表的列（有序）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">func (this *BaseDao) insertPrepareSQL() (fieldNames list.List, sql string) &#123;</span><br><span class="line">    names := new(bytes.Buffer)</span><br><span class="line">    values := new(bytes.Buffer)</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line"></span><br><span class="line">    for column, fieldName := range this.columnToField &#123;</span><br><span class="line"></span><br><span class="line">        if i != 0 &#123;</span><br><span class="line">            names.WriteString(&quot;,&quot;)</span><br><span class="line">            values.WriteString(&quot;,&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">        fieldNames.PushBack(fieldName)</span><br><span class="line">        names.WriteString(column)</span><br><span class="line">        values.WriteString(&quot;?&quot;)</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    sql = fmt.Sprintf(&quot;INSERT INTO %s (%s) VALUES (%s)&quot;, this.tableName, names.String(), values.String())</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>占位符的数据（有序）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">//预处理占位符的数据</span><br><span class="line">func (this *BaseDao) prepareValues(data interface&#123;&#125;, fieldNames list.List) []interface&#123;&#125; &#123;</span><br><span class="line">    values := make([]interface&#123;&#125;, len(this.columnToField))</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line">    for e := fieldNames.Front(); e != nil; e = e.Next() &#123;</span><br><span class="line">        name := e.Value.(string)</span><br><span class="line">        field := object.FieldByName(name)</span><br><span class="line">        values[i] = this.fieldValue(field)</span><br><span class="line">        i++</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return values</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//reflect.Value获取值</span><br><span class="line">func (this *BaseDao) fieldValue(v reflect.Value) interface&#123;&#125; &#123;</span><br><span class="line">    if !v.IsValid() &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch v.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        return v.String()</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        return v.Uint()</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        return v.Int()</span><br><span class="line">    case reflect.Float32, reflect.Float64:</span><br><span class="line">        return v.Float()</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch v.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            m := v.MethodByName(&quot;Format&quot;)</span><br><span class="line">            rets := m.Call([]reflect.Value&#123;reflect.ValueOf(timeFormate)&#125;)</span><br><span class="line">            t := rets[0].String()</span><br><span class="line">            return t</span><br><span class="line">        default:</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>增加记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//增加单个记录</span><br><span class="line">func (this *BaseDao) Save(data interface&#123;&#125;) error &#123;</span><br><span class="line">    columns, sql := this.insertPrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    args := this.prepareValues(data, columns)</span><br><span class="line">    fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">    _, err = stmt.Exec(args...)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//增加多个记录</span><br><span class="line">func (this *BaseDao) SaveAll(datas list.List) error &#123;</span><br><span class="line">    if datas.Len() == 0 &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">    columns, sql := this.insertPrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for e := datas.Front(); e != nil; e = e.Next() &#123;</span><br><span class="line">        args := this.prepareValues(e.Value, columns)</span><br><span class="line">        fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">        _, err = stmt.Exec(args...)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            panic(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8、修改"><a href="#8、修改" class="headerlink" title="8、修改"></a>8、修改</h2><ul>
<li>预处理的update语句封装以及占位符代表的列</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//实体转update sql语句</span><br><span class="line">func (this *BaseDao) updatePrepareSQL() (fieldNames list.List, sql string) &#123;</span><br><span class="line">    //UPDATE 表名称 SET 列名称 = 新值 WHERE 列名称 = 某值</span><br><span class="line">    sets := new(bytes.Buffer)</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line"></span><br><span class="line">    for column, fieldName := range this.columnToField &#123;</span><br><span class="line">        if strings.EqualFold(column, this.pk) &#123;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if i != 0 &#123;</span><br><span class="line">            sets.WriteString(&quot;,&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fieldNames.PushBack(fieldName)</span><br><span class="line">        sets.WriteString(column)</span><br><span class="line">        sets.WriteString(&quot;=?&quot;)</span><br><span class="line"></span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    fieldNames.PushBack(this.columnToField[this.pk])</span><br><span class="line">    sql = fmt.Sprintf(&quot;UPDATE %s SET %s WHERE %s=?&quot;, this.tableName, sets.String(), this.pk)</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>更新记录<br>和增加记录一样，获取到update语句及占位符的列名后，还需要根据列名获取到列的值（占位符的数据）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//更新一个实体</span><br><span class="line">func (this *BaseDao) Update(data interface&#123;&#125;) error &#123;</span><br><span class="line">    columns, sql := this.updatePrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    args := this.prepareValues(data, columns)</span><br><span class="line"></span><br><span class="line">    fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">    _, err = stmt.Exec(args...)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9、增加或修改"><a href="#9、增加或修改" class="headerlink" title="9、增加或修改"></a>9、增加或修改</h2><p>根据实体对象的ID是否有值来判断是保存还是更新。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//保存或更新一个实体，根据主键是否有值</span><br><span class="line">func (this *BaseDao) SaveOrUpdate(data interface&#123;&#125;) error &#123;</span><br><span class="line"></span><br><span class="line">    if this.isPkValue(data) &#123;</span><br><span class="line">        return this.Update(data)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return this.Save(data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//主键是否有值</span><br><span class="line">func (this *BaseDao) isPkValue(data interface&#123;&#125;) bool &#123;</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line">    pkName := this.columnToField[this.pk]</span><br><span class="line">    pkValue := object.FieldByName(pkName)</span><br><span class="line"></span><br><span class="line">    if !pkValue.IsValid() &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch pkValue.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        if len(pkValue.String()) &gt; 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        if pkValue.Uint() != 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        if pkValue.Int() != 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="10、删除"><a href="#10、删除" class="headerlink" title="10、删除"></a>10、删除</h2><ul>
<li>delete语句封装</li>
</ul>
<p>根据主键来删除数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//实体转delete sql语句</span><br><span class="line">func (this *BaseDao) deleteSQL(data interface&#123;&#125;) string &#123;</span><br><span class="line">    //DELETE FROM 表名称 WHERE 列名称 = 值</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line">    fieldValue := object.FieldByName(this.pk)</span><br><span class="line">    pkValue := this.valueToString(fieldValue)</span><br><span class="line">    return fmt.Sprintf(&quot;DELETE FROM  %s WHERE %s=%s&quot;, this.tableName, this.pk, pkValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//reflect.Value转字符串</span><br><span class="line">func (this *BaseDao) valueToString(v reflect.Value) string &#123;</span><br><span class="line">    values := new(bytes.Buffer)</span><br><span class="line">    switch v.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">        values.WriteString(v.String())</span><br><span class="line">        values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%d&quot;, v.Uint()))</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%d&quot;, v.Int()))</span><br><span class="line">    case reflect.Float32, reflect.Float64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%f&quot;, v.Float()))</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch v.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            m := v.MethodByName(&quot;Format&quot;)</span><br><span class="line">            rets := m.Call([]reflect.Value&#123;reflect.ValueOf(timeFormate)&#125;)</span><br><span class="line">            t := rets[0].String()</span><br><span class="line">            values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">            values.WriteString(t)</span><br><span class="line">            values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">        default:</span><br><span class="line">            values.WriteString(&quot;null&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line">        values.WriteString(&quot;null&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return values.String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>删除记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//删除一个实体</span><br><span class="line">func (this *BaseDao) Delete(data interface&#123;&#125;) error &#123;</span><br><span class="line">    _, err := Open().Exec(this.deleteSQL(data))</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11、查询"><a href="#11、查询" class="headerlink" title="11、查询"></a>11、查询</h2><ul>
<li>通过select语句获取到记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rows, err := Open().Query(sql)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">    fmt.Println(err.Error())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>获取列名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">defer rows.Close()</span><br><span class="line">columns, err := rows.Columns()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">    panic(err.Error())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据列名的顺序，把一行的值封装到一个EntityType对象中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">//对一条查询结果进行封装</span><br><span class="line">func (this *BaseDao) parseQuery(columns []string, values []interface&#123;&#125;) interface&#123;&#125; &#123;</span><br><span class="line">    obj := reflect.New(this.EntityType).Interface()</span><br><span class="line">    typ := reflect.ValueOf(obj).Elem()</span><br><span class="line"></span><br><span class="line">    for i, col := range values &#123;</span><br><span class="line">        if col != nil &#123;</span><br><span class="line">            name := this.columnToField[columns[i]]</span><br><span class="line">            field := typ.FieldByName(name)</span><br><span class="line"></span><br><span class="line">            this.parseQueryColumn(field, string(col.([]byte)))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//单个属性赋值</span><br><span class="line">func (this *BaseDao) parseQueryColumn(field reflect.Value, s string) &#123;</span><br><span class="line">    switch field.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        field.SetString(s)</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        v, _ := strconv.ParseUint(s, 10, 0)</span><br><span class="line">        field.SetUint(v)</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        v, _ := strconv.ParseInt(s, 10, 0)</span><br><span class="line">        field.SetInt(v)</span><br><span class="line">    case reflect.Float32:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 32)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Float64:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 64)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch field.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            v, _ := time.Parse(timeFormate, s)</span><br><span class="line">            field.Set(reflect.ValueOf(v))</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>把多个EntityType对象放到一个集合中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data := list.New() //创建一个新的list</span><br><span class="line"></span><br><span class="line">for rows.Next() &#123;</span><br><span class="line">    err = rows.Scan(scanArgs...)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    obj := this.parseQuery(columns, values)</span><br><span class="line">    data.PushBack(obj)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>查询单条记录<br>封装sql的时候加上limit限制，返回数据时，返回集合中的第一条（也是唯一的一条）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if isOne &amp;&amp; !strings.Contains(sql, &quot;limit&quot;) &#123;</span><br><span class="line">    sql = sql + &quot; limit 1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var data interface&#123;&#125;</span><br><span class="line">if datas.Len() &gt; 0 &#123;</span><br><span class="line">    data = datas.Front().Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>完整的查询代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">//根据SQL查询多条记录</span><br><span class="line">func (this *BaseDao) Find(sql string) (*list.List, error) &#123;</span><br><span class="line">    return this.query(sql, false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//根据SQL查询一条记录,如果找到不数据，data会返回nil</span><br><span class="line">func (this *BaseDao) FindOne(sql string) (interface&#123;&#125;, error) &#123;</span><br><span class="line">    datas, err := this.query(sql, true)</span><br><span class="line"></span><br><span class="line">    var data interface&#123;&#125;</span><br><span class="line">    if datas.Len() &gt; 0 &#123;</span><br><span class="line">        data = datas.Front().Value</span><br><span class="line">    &#125;</span><br><span class="line">    return data, err</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//根据SQL查询</span><br><span class="line">func (this *BaseDao) query(sql string, isOne bool) (*list.List, error) &#123;</span><br><span class="line">    if isOne &amp;&amp; !strings.Contains(sql, &quot;limit&quot;) &#123;</span><br><span class="line">        sql = sql + &quot; limit 1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    rows, err := Open().Query(sql)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defer rows.Close()</span><br><span class="line">    columns, err := rows.Columns()</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //构造scanArgs、values两个数组，scanArgs的每个值指向values相应值的地址</span><br><span class="line">    values := make([]interface&#123;&#125;, len(columns))</span><br><span class="line">    scanArgs := make([]interface&#123;&#125;, len(values))</span><br><span class="line">    for i := range values &#123;</span><br><span class="line">        scanArgs[i] = &amp;values[i]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data := list.New() //创建一个新的list</span><br><span class="line"></span><br><span class="line">    for rows.Next() &#123;</span><br><span class="line">        err = rows.Scan(scanArgs...)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            panic(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        obj := this.parseQuery(columns, values)</span><br><span class="line">        data.PushBack(obj)</span><br><span class="line">    &#125;</span><br><span class="line">    return data, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//对一条查询结果进行封装</span><br><span class="line">func (this *BaseDao) parseQuery(columns []string, values []interface&#123;&#125;) interface&#123;&#125; &#123;</span><br><span class="line">    obj := reflect.New(this.EntityType).Interface()</span><br><span class="line">    typ := reflect.ValueOf(obj).Elem()</span><br><span class="line"></span><br><span class="line">    for i, col := range values &#123;</span><br><span class="line">        if col != nil &#123;</span><br><span class="line">            name := this.columnToField[columns[i]]</span><br><span class="line">            field := typ.FieldByName(name)</span><br><span class="line"></span><br><span class="line">            this.parseQueryColumn(field, string(col.([]byte)))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//单个属性赋值</span><br><span class="line">func (this *BaseDao) parseQueryColumn(field reflect.Value, s string) &#123;</span><br><span class="line">    switch field.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        field.SetString(s)</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        v, _ := strconv.ParseUint(s, 10, 0)</span><br><span class="line">        field.SetUint(v)</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        v, _ := strconv.ParseInt(s, 10, 0)</span><br><span class="line">        field.SetInt(v)</span><br><span class="line">    case reflect.Float32:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 32)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Float64:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 64)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch field.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            v, _ := time.Parse(timeFormate, s)</span><br><span class="line">            field.Set(reflect.ValueOf(v))</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12、完整的ORM代码"><a href="#12、完整的ORM代码" class="headerlink" title="12、完整的ORM代码"></a>12、完整的ORM代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br></pre></td><td class="code"><pre><span class="line">package db</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;bytes&quot;</span><br><span class="line">    &quot;container/list&quot;</span><br><span class="line">    &quot;database/sql&quot;</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;reflect&quot;</span><br><span class="line">    &quot;strconv&quot;</span><br><span class="line">    &quot;strings&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line"></span><br><span class="line">    _ &quot;github.com/go-sql-driver/mysql&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">    timeFormate = &quot;2006-01-02 15:04:05&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var sqlDB *sql.DB</span><br><span class="line"></span><br><span class="line">func Open() *sql.DB &#123;</span><br><span class="line">    if sqlDB == nil &#123;</span><br><span class="line">        db, err := sql.Open(&quot;mysql&quot;, &quot;root:test@/time_table?charset=utf8&quot;)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            fmt.Println(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">        sqlDB = db</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sqlDB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type IBaseDao interface &#123;</span><br><span class="line">    Init()</span><br><span class="line">    Save(data interface&#123;&#125;) error</span><br><span class="line">    Update(data interface&#123;&#125;) error</span><br><span class="line">    SaveOrUpdate(data interface&#123;&#125;) error</span><br><span class="line">    SaveAll(datas list.List) error</span><br><span class="line">    Delete(data interface&#123;&#125;) error</span><br><span class="line">    Find(sql string) (*list.List, error)</span><br><span class="line">    FindOne(sql string) (interface&#123;&#125;, error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type BaseDao struct &#123;</span><br><span class="line">    EntityType    reflect.Type</span><br><span class="line">    sqlDB         *sql.DB</span><br><span class="line">    tableName     string            //表名</span><br><span class="line">    pk            string            //主键</span><br><span class="line">    columnToField map[string]string //字段名:属性名</span><br><span class="line">    fieldToColumn map[string]string //属性名:字段名</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//初始化</span><br><span class="line">func (this *BaseDao) Init() &#123;</span><br><span class="line">    this.columnToField = make(map[string]string)</span><br><span class="line">    this.fieldToColumn = make(map[string]string)</span><br><span class="line"></span><br><span class="line">    types := this.EntityType</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; types.NumField(); i++ &#123;</span><br><span class="line">        typ := types.Field(i)</span><br><span class="line">        tag := typ.Tag</span><br><span class="line"></span><br><span class="line">        if len(tag) &gt; 0 &#123;</span><br><span class="line">            column := tag.Get(&quot;column&quot;)</span><br><span class="line">            name := typ.Name</span><br><span class="line">            this.columnToField[column] = name</span><br><span class="line">            this.fieldToColumn[name] = column</span><br><span class="line"></span><br><span class="line">            if len(tag.Get(&quot;table&quot;)) &gt; 0 &#123;</span><br><span class="line">                this.tableName = tag.Get(&quot;table&quot;)</span><br><span class="line">                this.pk = column</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//增加单列</span><br><span class="line">func (this *BaseDao) Save(data interface&#123;&#125;) error &#123;</span><br><span class="line">    columns, sql := this.insertPrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    args := this.prepareValues(data, columns)</span><br><span class="line">    fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">    _, err = stmt.Exec(args...)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//集合保存</span><br><span class="line">func (this *BaseDao) SaveAll(datas list.List) error &#123;</span><br><span class="line">    if datas.Len() == 0 &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">    columns, sql := this.insertPrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for e := datas.Front(); e != nil; e = e.Next() &#123;</span><br><span class="line">        args := this.prepareValues(e.Value, columns)</span><br><span class="line">        fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">        _, err = stmt.Exec(args...)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            panic(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//更新一个实体</span><br><span class="line">func (this *BaseDao) Update(data interface&#123;&#125;) error &#123;</span><br><span class="line">    columns, sql := this.updatePrepareSQL()</span><br><span class="line"></span><br><span class="line">    stmt, err := Open().Prepare(sql)</span><br><span class="line">    args := this.prepareValues(data, columns)</span><br><span class="line"></span><br><span class="line">    fmt.Println(sql, &quot; &quot;, args)</span><br><span class="line">    _, err = stmt.Exec(args...)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//实体转update sql语句</span><br><span class="line">func (this *BaseDao) updatePrepareSQL() (fieldNames list.List, sql string) &#123;</span><br><span class="line">    //UPDATE 表名称 SET 列名称 = 新值 WHERE 列名称 = 某值</span><br><span class="line">    sets := new(bytes.Buffer)</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line"></span><br><span class="line">    for column, fieldName := range this.columnToField &#123;</span><br><span class="line">        if strings.EqualFold(column, this.pk) &#123;</span><br><span class="line">            continue</span><br><span class="line">        &#125;</span><br><span class="line">        if i != 0 &#123;</span><br><span class="line">            sets.WriteString(&quot;,&quot;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fieldNames.PushBack(fieldName)</span><br><span class="line">        sets.WriteString(column)</span><br><span class="line">        sets.WriteString(&quot;=?&quot;)</span><br><span class="line"></span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    fieldNames.PushBack(this.columnToField[this.pk])</span><br><span class="line">    sql = fmt.Sprintf(&quot;UPDATE %s SET %s WHERE %s=?&quot;, this.tableName, sets.String(), this.pk)</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//保存或更新一个实体，根据主键是否有值</span><br><span class="line">func (this *BaseDao) SaveOrUpdate(data interface&#123;&#125;) error &#123;</span><br><span class="line"></span><br><span class="line">    if this.isPkValue(data) &#123;</span><br><span class="line">        return this.Update(data)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return this.Save(data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//主键是否有值</span><br><span class="line">func (this *BaseDao) isPkValue(data interface&#123;&#125;) bool &#123;</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line">    pkName := this.columnToField[this.pk]</span><br><span class="line">    pkValue := object.FieldByName(pkName)</span><br><span class="line"></span><br><span class="line">    if !pkValue.IsValid() &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch pkValue.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        if len(pkValue.String()) &gt; 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        if pkValue.Uint() != 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        if pkValue.Int() != 0 &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//预处理占位符的数据</span><br><span class="line">func (this *BaseDao) prepareValues(data interface&#123;&#125;, fieldNames list.List) []interface&#123;&#125; &#123;</span><br><span class="line">    values := make([]interface&#123;&#125;, len(this.columnToField))</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line">    for e := fieldNames.Front(); e != nil; e = e.Next() &#123;</span><br><span class="line">        name := e.Value.(string)</span><br><span class="line">        field := object.FieldByName(name)</span><br><span class="line">        values[i] = this.fieldValue(field)</span><br><span class="line">        i++</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return values</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//reflect.Value获取值</span><br><span class="line">func (this *BaseDao) fieldValue(v reflect.Value) interface&#123;&#125; &#123;</span><br><span class="line">    if !v.IsValid() &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    switch v.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        return v.String()</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        return v.Uint()</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        return v.Int()</span><br><span class="line">    case reflect.Float32, reflect.Float64:</span><br><span class="line">        return v.Float()</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch v.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            m := v.MethodByName(&quot;Format&quot;)</span><br><span class="line">            rets := m.Call([]reflect.Value&#123;reflect.ValueOf(timeFormate)&#125;)</span><br><span class="line">            t := rets[0].String()</span><br><span class="line">            return t</span><br><span class="line">        default:</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (this *BaseDao) insertPrepareSQL() (fieldNames list.List, sql string) &#123;</span><br><span class="line">    names := new(bytes.Buffer)</span><br><span class="line">    values := new(bytes.Buffer)</span><br><span class="line"></span><br><span class="line">    i := 0</span><br><span class="line"></span><br><span class="line">    for column, fieldName := range this.columnToField &#123;</span><br><span class="line"></span><br><span class="line">        if i != 0 &#123;</span><br><span class="line">            names.WriteString(&quot;,&quot;)</span><br><span class="line">            values.WriteString(&quot;,&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">        fieldNames.PushBack(fieldName)</span><br><span class="line">        names.WriteString(column)</span><br><span class="line">        values.WriteString(&quot;?&quot;)</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">    sql = fmt.Sprintf(&quot;INSERT INTO %s (%s) VALUES (%s)&quot;, this.tableName, names.String(), values.String())</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//删除一个实体</span><br><span class="line">func (this *BaseDao) Delete(data interface&#123;&#125;) error &#123;</span><br><span class="line">    _, err := Open().Exec(this.deleteSQL(data))</span><br><span class="line">    return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//实体转delete sql语句</span><br><span class="line">func (this *BaseDao) deleteSQL(data interface&#123;&#125;) string &#123;</span><br><span class="line">    //DELETE FROM 表名称 WHERE 列名称 = 值</span><br><span class="line">    object := reflect.ValueOf(data).Elem()</span><br><span class="line">    fieldValue := object.FieldByName(this.pk)</span><br><span class="line">    pkValue := this.valueToString(fieldValue)</span><br><span class="line">    return fmt.Sprintf(&quot;DELETE FROM  %s WHERE %s=%s&quot;, this.tableName, this.pk, pkValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//reflect.Value转字符串</span><br><span class="line">func (this *BaseDao) valueToString(v reflect.Value) string &#123;</span><br><span class="line">    values := new(bytes.Buffer)</span><br><span class="line">    switch v.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">        values.WriteString(v.String())</span><br><span class="line">        values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%d&quot;, v.Uint()))</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%d&quot;, v.Int()))</span><br><span class="line">    case reflect.Float32, reflect.Float64:</span><br><span class="line">        values.WriteString(fmt.Sprintf(&quot;%f&quot;, v.Float()))</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch v.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            m := v.MethodByName(&quot;Format&quot;)</span><br><span class="line">            rets := m.Call([]reflect.Value&#123;reflect.ValueOf(timeFormate)&#125;)</span><br><span class="line">            t := rets[0].String()</span><br><span class="line">            values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">            values.WriteString(t)</span><br><span class="line">            values.WriteString(&quot;&apos;&quot;)</span><br><span class="line">        default:</span><br><span class="line">            values.WriteString(&quot;null&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line">        values.WriteString(&quot;null&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return values.String()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//根据SQL查询多条记录</span><br><span class="line">func (this *BaseDao) Find(sql string) (*list.List, error) &#123;</span><br><span class="line">    return this.query(sql, false)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//根据SQL查询一条记录,如果找到不数据，data会返回nil</span><br><span class="line">func (this *BaseDao) FindOne(sql string) (interface&#123;&#125;, error) &#123;</span><br><span class="line">    datas, err := this.query(sql, true)</span><br><span class="line"></span><br><span class="line">    var data interface&#123;&#125;</span><br><span class="line">    if datas.Len() &gt; 0 &#123;</span><br><span class="line">        data = datas.Front().Value</span><br><span class="line">    &#125;</span><br><span class="line">    return data, err</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//根据SQL查询</span><br><span class="line">func (this *BaseDao) query(sql string, isOne bool) (*list.List, error) &#123;</span><br><span class="line">    if isOne &amp;&amp; !strings.Contains(sql, &quot;limit&quot;) &#123;</span><br><span class="line">        sql = sql + &quot; limit 1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    rows, err := Open().Query(sql)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    defer rows.Close()</span><br><span class="line">    columns, err := rows.Columns()</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        panic(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //构造scanArgs、values两个数组，scanArgs的每个值指向values相应值的地址</span><br><span class="line">    values := make([]interface&#123;&#125;, len(columns))</span><br><span class="line">    scanArgs := make([]interface&#123;&#125;, len(values))</span><br><span class="line">    for i := range values &#123;</span><br><span class="line">        scanArgs[i] = &amp;values[i]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data := list.New() //创建一个新的list</span><br><span class="line"></span><br><span class="line">    for rows.Next() &#123;</span><br><span class="line">        err = rows.Scan(scanArgs...)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            panic(err.Error())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        obj := this.parseQuery(columns, values)</span><br><span class="line">        data.PushBack(obj)</span><br><span class="line">    &#125;</span><br><span class="line">    return data, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//对一条查询结果进行封装</span><br><span class="line">func (this *BaseDao) parseQuery(columns []string, values []interface&#123;&#125;) interface&#123;&#125; &#123;</span><br><span class="line">    obj := reflect.New(this.EntityType).Interface()</span><br><span class="line">    typ := reflect.ValueOf(obj).Elem()</span><br><span class="line"></span><br><span class="line">    for i, col := range values &#123;</span><br><span class="line">        if col != nil &#123;</span><br><span class="line">            name := this.columnToField[columns[i]]</span><br><span class="line">            field := typ.FieldByName(name)</span><br><span class="line"></span><br><span class="line">            this.parseQueryColumn(field, string(col.([]byte)))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//单个属性赋值</span><br><span class="line">func (this *BaseDao) parseQueryColumn(field reflect.Value, s string) &#123;</span><br><span class="line">    switch field.Kind() &#123;</span><br><span class="line">    case reflect.String:</span><br><span class="line">        field.SetString(s)</span><br><span class="line">    case reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64:</span><br><span class="line">        v, _ := strconv.ParseUint(s, 10, 0)</span><br><span class="line">        field.SetUint(v)</span><br><span class="line">    case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64:</span><br><span class="line">        v, _ := strconv.ParseInt(s, 10, 0)</span><br><span class="line">        field.SetInt(v)</span><br><span class="line">    case reflect.Float32:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 32)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Float64:</span><br><span class="line">        v, _ := strconv.ParseFloat(s, 64)</span><br><span class="line">        field.SetFloat(v)</span><br><span class="line">    case reflect.Struct:</span><br><span class="line">        switch field.Type().String() &#123;</span><br><span class="line">        case &quot;time.Time&quot;:</span><br><span class="line">            v, _ := time.Parse(timeFormate, s)</span><br><span class="line">            field.Set(reflect.ValueOf(v))</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12、ORM使用"><a href="#12、ORM使用" class="headerlink" title="12、ORM使用"></a>12、ORM使用</h2><ul>
<li>定义一个Entity</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/*entity*/</span><br><span class="line">type Chair struct &#123;</span><br><span class="line">    Id              int       `table:&quot;device_chair&quot; column:&quot;id&quot;`</span><br><span class="line">    Time            time.Time `column:&quot;time&quot;`</span><br><span class="line">    Day             string    `column:&quot;day&quot;`</span><br><span class="line">    Origin          string    `column:&quot;origin&quot;`</span><br><span class="line">    ParentSerial    string    `column:&quot;parent_serial&quot;`</span><br><span class="line">    Serial          string</span><br><span class="line">    RunningNumber   string  `column:&quot;running_number&quot;`</span><br><span class="line">    PointA          float32 `column:&quot;point_a&quot;`</span><br><span class="line">    PointB          float32 `column:&quot;point_b&quot;`</span><br><span class="line">    PointC          float32 `column:&quot;point_c&quot;`</span><br><span class="line">    PointD          float32 `column:&quot;point_d&quot;`</span><br><span class="line">    PointE          float32 `column:&quot;point_e&quot;`</span><br><span class="line">    PointF          float32 `column:&quot;point_f&quot;`</span><br><span class="line">    Voltage         float32 `column:&quot;voltage&quot;`</span><br><span class="line">    SeatingPosition uint8   `column:&quot;seating_position&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过组合的方式实体BaseDao的继承</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/*dao*/</span><br><span class="line">type IChairDao interface &#123;</span><br><span class="line">    db.IBaseDao</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type chairDao struct &#123;</span><br><span class="line">    db.BaseDao</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化Dao<br>这个过程中记得要给BaseDao传入EntityType的值，并调用Init方法进行初始化工作。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var chairDaoImpl IChairDao</span><br><span class="line"></span><br><span class="line">func ChairDao() IChairDao &#123;</span><br><span class="line">    if chairDaoImpl == nil &#123;</span><br><span class="line">        chairDaoImpl = &amp;chairDao&#123;db.BaseDao&#123;EntityType: reflect.TypeOf(new(Chair)).Elem()&#125;&#125;</span><br><span class="line">        chairDaoImpl.Init()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return chairDaoImpl</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Dao使用<br>这里使用增加数据为例子</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chair := new(Chair)</span><br><span class="line">chair.Id = 129986</span><br><span class="line">chair.SeatingPosition = 10</span><br><span class="line">chair.Day = chair.Time.Format(&quot;2006-01-02&quot;)</span><br><span class="line">err = ChairDao().Save(chair)</span><br></pre></td></tr></table></figure>
<h2 id="13、未完成"><a href="#13、未完成" class="headerlink" title="13、未完成"></a>13、未完成</h2><ol>
<li>多模式主键的支持</li>
<li>外键关联的支持</li>
<li>事务的支持</li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a href="/2016/07/23/51980036/" class="pre">Spring Boot集成MyBatis开发Web项目</a><a href="/2016/04/07/51083743/" class="next">mysql update使用子查询</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2013-2018 <a href="/." rel="nofollow">笨笨个人笔记.</a></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.4" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.4" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.4"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.4"></script><script type="text/javascript" src="/js/prism.js?v=1.0.4"></script></div></body></html>